\chapter{Převedení na optimalizační úlohu}

\section{Formalizace problému}

Ústředním problémem pohotovostních služeb je umět naplánovat týmy záchranářů a záchranná vozidla na výjezdové stanice tak, aby efektivně odbavili co největší počet incidentů,
za co nejméně zbytečně vynaložených nákladů, v rámci jednoho dne.
Naším cílem je vymyslet metody, jak být schopný taková optimální naplánovaní nalézt.
Z toho důvodu je v první řadě potřeba si problém zformalizovat a jasně si tak vymezit, jaký konkrétní problém řešíme.

Pohotovostní služba má k dispozici \textit{týmy záchranářů} $Z = \{ z_1, z_2, \dots, z_{Z_n} \}$, \textit{záchranná vozidla} $A = \{ a_1, a_2, \dots\ a_{A_n} \}$
a \textit{výjezdové stanice} $V = \{ v_1, v_2, \dots, v_{V_n} \}$. 
Na území působnosti pohotovostní služby se nachází nemocnice $H = \{ h_1, h_2, \dots h_{H_n} \}$.
Pohotovostní služba definuje \textit{pracovní směny} týmů záchranářů $D = D_{s} \times D_{l}$, 
kde $D_{s} \in \mathbb{N}_0$ množina \textit{začátků pracovních směn} a $D_{l} \in \mathbb{N}_0$ množina \textit{délek pracovních směn}.
\textit{Pracovní směna} $d \in D$ je tak dvojice $d = (d_s, d_l)$, kde $d_{s} \in D_{s}$ značí začátek a $d_{l} \in D_{l}$ délku trvání směny.
Nechť $D_n = |D|$ a připomeňme $Z_n = |Z|$,  $A_n = |A|$,  $V_n = |V|$, $H_n = |H|$.

Plánem pohotovostní služby chápeme přiřazení týmů záchranářů $z \in Z$ a záchranných vozidel $a \in A$ na konkrétní výjezdové stanice $v \in V$
a přiřazení pracovní směny $d \in D$ každému týmu záchranářů $z \in Z$ v rámci jednoho dne.
Tato přiřazení popíšeme \textit{přiřazovacími funkcemi}:
\begin{definice}[Přiřazovací funkce]
  \begin{alignat*}{2}
    p_Z \colon Z &\rightarrow V \cup \{ v_{\emptyset} \} \quad && \hspace{30pt} \text{přiřazení týmů na stanice}, \\
    p_A \colon A &\rightarrow V \cup \{ v_{\emptyset} \} \quad && \hspace{30pt} \text{přiřazení vozidel na stanice}, \\ 
    p_{D} \colon Z &\rightarrow D                        \quad && \hspace{30pt} \text{přiřazení směn týmům}.
  \end{alignat*}
\end{definice}
Tým $z \in Z$ nemá přiřazenou žádnou výjezdovou stanici právě tehdy, když
$p_{Z}(z) = v_{\emptyset}$ a $p_{D}(z) = (d_s, d_l) \colon d_l = 0$.
Záchranné vozidlo $a \in A$ nemá přiřazenou žádnou výjezdovou stanici, právě tehdy, když $p_{A}(a) = a_{\emptyset}$.

Pro pohodlnost zaveďme:
\begin{align*}
  & p_{D_s}(z) \colon p_D(z) = (d_s, d_l) \Leftrightarrow p_{D_s}(z) = d_s, \\
  & p_{D_l}(z) \colon  p_D(z) = (d_s, d_l) \Leftrightarrow p_{D_l}(z) = d_l.
\end{align*}

\textit{Plánem pohotovnostní služby} budeme označovat 
čtveřici
\begin{align*}
  p = (p_Z, p_A, p_{D_{s}}, p_{D_{l}}) \in P,
\end{align*}
kde P je množina všech plánů pohotovostních služeb.
Množina $P$ obsahuje všechny plány, ale ne všechny plány jsou pro nás zajímavé.
Zajímat nás budou pouze plány, které splňují nějaké \textit{omezující podmínky}.
Pohotovostní služba definuje omezující podmínky, a to konkrétně \textit{maximální počty týmů záchranářů a záchranných vozidel povolených na jednotlivých výjezdových stanicích}.
\begin{definice}[Omezující podmínky pohotovostního plánu]
  Nechť $c^z, c^a \in \mathbb{N}^{V_n}$ vektory, 
  kde $i$-tou položku definujeme:
  \begin{align*}
    &c^z_i \hspace{20pt} \text{maximální počet záchranných týmů na výjezdové stanici $v_i \in V$}, \\ 
    &c^a_i \hspace{20pt} \text{maximální počet záchranných vozidel na výjezdové stanici $v_i \in V$},
  \end{align*}
  pro $1 \leq i \leq V_n$.
  Nechť omezující podmínky $C = \{ C_Z, C_A \}$, kde $C_Z \colon P \rightarrow \{ 0, 1 \}$, $C_A \colon P \rightarrow \{ 0, 1 \}$, definované:

  \begin{align*}
    C_Z(p) = 1 &\iff |\{ z \in Z \mid p_Z(z) = v_i \}| \leq c^z_i, \hspace{20pt} \text{jinak 0}, \\
    C_A(p) = 1 &\iff |\{ a \in A \mid p_A(a) = v_i \}| \leq c^a_i, \hspace{20pt} \text{jinak 0},
  \end{align*}
  $\forall i \colon 1 \leq i \leq V_n$, $p \in P$.
\end{definice}

Plán pohotovostní služby $p \in P$ splňující omezující podmínky $C$ je plán, který splňuje:
\begin{align*}
    C_Z(p) = 1 \land C_A(p) = 1.
\end{align*}
V opačném případě $p$ nesplňuje omezující podmínky $C$.
Označme $P_C$ jako \textit{množinu plánů splňujících omezující podmínky $C$}.

Pohotovostní plán pak bude v průběhu dne odbavovat \textit{incidenty}.
\textit{Incident} je trojice:
\begin{enumerate}
  \item místo nastání,
  \item čas nastání,
  \item požadováná maximální doba příjezdu záchranné jednotky.
\end{enumerate}
Budeme vždy uvažovat pouze incidenty, které se odehrávájí v rámci jednoho dne, označme $I$.
Zároveň neexistují dva incidenty, které se odehrají v přesně stejný čas.

Problém, který v této práci řešíme, je nalézt optimální plán $p_C \in P_C \subseteq P$ při nějak vhodně definované účelové funkci,
která bude maximalizovat počet úspěšně odbavených incidentů a minimalizovat celkovou cenu plánu.

Co je úspěšně odbavený incident a jakým způsobem zjistíme kolik incidentů plán úspěšně odbaví je detailně popisováno v následující kapitole. 
Co budeme považovat za cenu plánu lze nalézt v definici \ref{df:cenaPlanu}.

\section{Simulace plánu pohotovostní služby}\label{SimulaceKap}

Naším cílem je umět nalézt optimální plán pohotovostní služby.
Ten určujeme podle počtu úspěšně odbavených incidentů $s$ a ceny plánu $u$.
Z toho důvodu jsme si formálně nadefinovali protředky, které má pohotovostní služba k dispozici a co je plán pohotovostní služby.

V kapitole \ref{kap:optUloha2uc} definujeme cenu plánu (viz definice \ref{df:cenaPlanu}).
V této kapitole navrhneme způsob, jakým zjistíme $s$ pohotovostního plánu $p$ na množine incidentů $I$.
Pro zjištění $s$ spustíme simulaci pohotovostního plánu $p$ na dané množině $I$.
Následně formálně popíšeme simulaci a jaká pravidla chodu simulace se rozhodneme použít.
Proč zrovna použijeme přístupu simulace je popsáno v nadcházející kapitole.

\subsection{Proč simulace?}\label{kap:procSimulace}

Je velmi důležité, aby počet úspěšně odbavených incidentů, které budeme uvažovat při optimalizaci co nejvíce odpovídal počtu úspěšně odbavených incidentů,
kdyby byl plán $p$ použit v reálném světě a v průběhu dne by se přesně děly incidenty $I$.
Přesně k takovému účelu se používají simulace.
Simulace bude simulovat chování plánu v průběhu dne tak, jak by se plán skutečně choval v reálném světě.
Čím více bude simulace navžena tak, aby co nejvíce odpovídala chování plánu v reálném světě, tím více bude počet úspěšně odbavených incidentů simulace odpovídat
počtu úspěšně odbavených incidentů reálnému chování.

Přístup použití simulace má ještě jednu podstatnou výhodu.
Různé pohotovostní služby mohou používat různé způsoby a pravidla, například pro výběr záchranného týmu a vozidla pro odbavení incidentu co právě nastal, nebo do jaké nemocnice incident odbavit.
Tato pravidla můžou být příliš složitá, aby je bylo možné výstižně zachytit jinými způsoby, jako například pouze matematickými rovnostmi a nerovnostmi, jak je zvykem pro lineární programování \cite{LP}.

Avšak podstatnou nevýhodou simulace je její výpočetní náročnost a poměrně značné omezení použitelných technik obecně využívaných pro řešení optimalizačních problémů.

\subsection{Popis deterministické diskrétní simulace}

\textit{Simulace} je proces navrhnutí modelu reálného systému a provádění tak na něm experimenty za účelem buď porozumění chování systému
nebo za účelem vyhodnocení různých strategií chování systému.
\textit{Systém simulace} je chápan jako dobře definovaná kolekce objektů a interakcí mezi nimi.
Simulace si udržuje \textit{stav systému}. Ten definuje jak se má simulace chovat.
Systém simulace se může měnit průběhem simulace nebo při nastání \textit{události}.

Simulace obecně dělíme na \textit{spojité} a \textit{diskrétní}.
V \textit{spojité simulaci} se změny systému dějí kontinuálně v průběhu běhu simulace, nejčastěji podle soustavy diferenciálních rovnic.
V \textit{diskrétní simulaci} se změny sytému dějí v diskrétních časoých úsecích, nejčastěji v čase nastání nějaké \textit{události}.

Klasický způsob jak diskrétní simulace probíhá je následovný.
Simulace odbavuje údalosti v pořadí nastání v čase.
Při inicializaci si naplánuje nějaké údalosti.
Při odbavování události aktualizuje stav systému podle předchozího stavu systému a aktuálně odbavované události. Zároveň si simulace náplanuje další události. 
Simulace skončí jakmile nejsou žádné další události k odbavení.

Dále dělíme simulace na \textit{deterministcké} a \textit{stochastické}.
V \textit{deterministické simulaci} jsme schopni z aktuálního stavu systému a údalosti deterministicky určit nadcházející stav systému.
V \textit{stochastické simulaci} nejsme schopni z aktuálního stavu systému a údalosti deterministicky určit nadcházející stav systému.
Většinou proto, že při výběru nadhcázejícího stavu figuruje element náhody.
\cite{SimulaceBook}

\subsection{Popis deterministické diskrétní simulace plánu pohotovostní služby}\label{kap:definiceSimulace}

Abychom mohli simulovat fungování pohotovostního plánu,
potřebujeme si první definovat, jaké podmínky musí záchranný tým splňovat, aby mohl \textit{úspěšně odbavit incident}.

\begin{definice}\label{df:simulacePravidla1}
  Tým záchranářů $z \in Z$ je schopen úspěšně odbavit incident $i \in I$ právě tehdy, když:
  \begin{enumerate}
    \item
      Je alokován a má přiřazenou směnu. Pokud tým záchranářu není alokován, tj. $p_Z(z) = v_{\emptyset}$, tak samozřejmě není schopen obsloužit $i$.

    \item
      Tým je schopen dorazit na místo incidentu do \emph{požadované doby}.
      Ať už přímo z výjezdové stanice, nebo při vrácení se po vyřízení incidentu zpět na výjezdovou stanici. 
      V prvním případě tým potřebuje mít na výjezdové stanici k dispozi volné záchranné vozidlo.

    \item
      Týmu nekončí směna dříve, než je očekávaný konec celkové doby vyřízení incidentu.
  \end{enumerate}
\end{definice}

Nechť $Z_i \subseteq Z$ množina záchranných týmu, které jsou schopny úspěšně odbavit incident $i \in I$.
Pro odbavení $i$ musíme vybrat nějaký konkrétní $z_i \in Z_i$.

Je mnoho různých způsobu, jak $z_i$ vybrat.
V naší simulaci jsou použitá pravidla vybraná na základě konzultace se společností, která se danou problematikou zabývá přes 25 let
a sami podobná pravidla používají pro plánovaní u několika jejich klientů ve Spojených státech.

Simulace je navržena dostatečně genericky, aby bylo možné naimplementovat i libovolná jiná pravidla, například jednodušší, komplikovanější nebo klidně i stochastická.
Jak bylo zmíněno v kapitole \ref{kap:procSimulace}, možnost volby libovolných pravidel je výhoda přístupu použití simulace.
\begin{definice}\label{df:simulacePravidla2}
  Nejvhodnější tým záchranářů $z_i \in Z_i$, kde $Z_i \subseteq Z$ jsou všechny týmy záchranářů schopny úspěšně odbavit incident $i \in I$ je tým,
  který je nejlepší podle následujících kritérií v daném pořadí:
  \begin{enumerate}
    \item Upřednostni tým, který je na výjezdové stanici před týmem, který ještě ukončuje vyřízení jednoho z předchozích incidentů. 
    \item Upřednostni tým, který na místo incidentu dorazí dříve. 
    \item Upřednostni tým, který obsloužil méně incidentů a je tedy méně vyčerpaný.
  \end{enumerate}
\end{definice}
Pravidla výběru \textit{nejvhodnějšího týmu záchranářů} jsou navrhnuta tak,
aby práce obsluhování incidentů byla rozmístěna rovnoměrně přes všechny týmy, ale aby zároveň byly incidenty obslouženy nejrychleji jak je možné.
Například, třetí pravidlo pro výběr nejvhodnějšího týmu zaručuje rovnoměrnost práce a druhé co nejrychlejší obsloužení incidentu.

Pravidla také počítají s možným zpožděním a raději upřednostní tým, který je aktuálně k dispozici, než tým, který ještě dokončuje jiný incident, ale mohl by i na místě incidentu
být dříve, pokud by neměl zpoždění. Příkladem je první pravidlo pro výběr nejvhodnějšího týmu.

Jakmile je $z_i$ vybrán, naplánujeme mu incident $i$ a $z_i$ \textit{odbavuje incident $i$}.
\begin{definice}[Záchranný tým odbavuje incident]\label{df:odbavujeIncident}
  Řekneme, že záchranný tým $z \in Z$ odbavuje incident $i \in I$, pokud vykonává následující činnosti:
  \begin{enumerate}
    \item
      Tým $z$ přijíží na místo odehrání incidentu $i$.

    \item
      Tým $z$ odbavuje incident na místě odehrání incidentu $i$.

    \item
      Tým $z$ pacienty z incidentu $i$ převáží do nejbližší nemocnice.

    \item
      Tým $z$ pacienty odbavuje v nemocnici.

    \item
      Tým $z$ přijíždí zpět na výjezdovou stanici.
  \end{enumerate}
\end{definice}
Definujme si funkce, které budou v simulaci používány a pomocí výše uvedených pravidel naleznou nejvhodnější tým záchranářů $z_i$
a pro něj nejvhodnější záchranné vozidlo.
\begin{definice}[GetBestTeam]\label{df:getBestTeam}
Funkce \textit{GetBestTeam} vrací tým záchranářu $z_i$ z týmů záchranářů $Z_i$, kteří jsou schopni úspěšně odbavit aktuální incident $i \in I$~(viz definice \ref{df:simulacePravidla1})
  , kde $z_i$ je nejvhodnější tým pro obsloužení incidentu $i$ ze $Z_i$~(viz definice \ref{df:simulacePravidla2}). 
\end{definice}
\begin{definice}[GetBestAmbulance]
Funkce \textit{GetBestAmbulance}\label{df:getBestAmbulance} vybere záchranné vozidlo, které je na stejné výjezdové stanici jako $z_i$ a časově je nejdříve k dispozici.
\end{definice}

Nyní jsme připraveni definovat \textit{simulaci pohotovostního plánu} $p \in P_C$ na množině incidentů $I$, a to jako deterministickou diskrétní simulaci
\begin{align*}
  s = s(p, I).
\end{align*}
Simulace vrátí počet úspěšně odbavených incidentů $s$ na množině $I$ plánem $p$. 

\textit{Událost} je nastání incidentu 
\begin{align*}
  i \in I \text{ v čase } T_I(i),
\end{align*}
kde $T_I \colon I \rightarrow \mathbb{N}_0$, určuje čas nastání incidentu.
\textit{Stav systému} simulace $s$ je množina
\begin{align*}
S = \{ S_A, S_Z \},
\end{align*}
kde $S_A$ je stav záchranných vozidel $A$ a $S_Z$ je stav týmů záchranářů $Z$. 
Stav $S_A$ je rozmístění záchranných vozidel v prostoru.
Stav $S_Z$ je informace, kdy bude záchranný tým k dispozici a pokud tým odbavuje nějaký incident, tak v jaké fázi odbavování zrovna je. 

\begin{algorithm}[H]
  \begin{algorithmic}[1]
  \Function{Simulation}{$p, I$}
    \State $s \gets 0$
    \State $T$ \gets 0
    \State $I' \gets \mbox{Setřídí $I$ podle času nastání, pomocí $T_I$}$
    \State $S_Z \gets \mbox{Inicializuje podle $p$}$
    \State $S_A \gets \mbox{Inicializuje podle $p$}$
    \For{$i_k \in I',~ k \in \{1, 2, \dots , |I|\}$}
      \State $T \gets \mbox{Čas nastání $i_k$, $T_I(i_k)$}$
      \State $z_k \gets \mbox{GetBestTeam($i_k, S_Z, S_A, T$)}$
      \If{$z_k \neq \emptyset$}
        \State $s \gets s + 1$
        \State $a_k \gets \mbox{GetBestAmbulance($z_k, T$)}$
        \State Plan($z_k, a_k, i_k$)
      \EndIf
      \State $S_Z \gets \mbox{UpdateState($S_Z, i_k, z_k$)}$
      \State $S_A \gets \mbox{UpdateState($S_A, i_k, a_k$)}$
    \EndFor
    \State \Return $s$
  \EndFunction
  \end{algorithmic}
  \caption{Simulace plánu pohotovostní služby $p$ na množině incidentů $I$}
  \label{simulaceAlgo}
\end{algorithm}

\vspace*{10px}

Průběh simulace je následovný. 
V krocích 2 až 6 simulace (viz algoritmus \ref{simulaceAlgo}) položí $s$ a $T$ rovno nule, setřídí si sadu incidentů podle časů nastání
a incicializuje si stavy $S_A$ a $S_Z$ podle plánu $p$.

V krocích 7 až 17 odbavuje události, takže se pohybuje po krocích v časech nastání incidentů od nejdřívějšího po nejpozdější.
V každém kroku simulace $k \in \{ 1, 2, \dots , |I|\}$ se simulace první pokusí deterministicky nalézt nejvhodnější $z_k \in Z$, který obslouží $i_k$,
pomocí funkce $\textit{GetBestTeam}$ (viz definice \ref{df:getBestTeam}), v kroku 9. 
Pokud takový $z_k$ neexistuje, tak pokračuje v odbavování dalších incidentů.

Pokud existuje, v krocích 8 až 13 zvýší počet odbavených incidentů $s$ o jedna,
deterministicky nalezne pro $z_k$ nejvhodnější $a_k$, pomocí funkce \textit{GetBestAmbulance} (viz definice \ref{df:getBestAmbulance}) a
aktuální incident $i_k$ naplánuje na $z_k$ spolu s $a_k$ funkcí \textit{Plan}.
Záchranný tým $z_k$ tak \textit{odbavuje} incident $i_k$ (viz definice \ref{df:odbavujeIncident}), a čas, kdy bude opět tým $z_k$ k dispozici je nastaven na čas, kdy incident úspěšně odbaví. 

V krocích 15 a 16 aktualizuje stav systému $S_A$ a $S_Z$.
Simulace doběhne jakmile nejsou žádné další události k odbavení, takže jakmile projde všechny incidenty, to je po $|I|$ krocích.
Simulace vrátí $s$, počet úspěšně odbavených incidentů.

\section{Převedení problému na optimalizační úlohu s více účelovými funkcemi}\label{kap:optUloha2uc}

V této kapitole si ukážeme, jak konkrétně budeme modelovat optimalizační úlohu nalezení optimálního pohotovostního plánu na množině incidentů $I$,
pomocí počtu úspěšně odbavených incidentů $s$ a ceny plánu $u$.
Dále si nadefinujeme potřebné pojmy, jako \textit{optimalizační úlohu s více nebo s jednou účelovou funkcí}.
Ukážeme si, že problém nalezení optimálního plánu je vhodné modelovat jako optimalizační úlohu s více účelovými funkcemi,
protože chceme maximalizovat počet úspěšně odbavených incidentů a zároveň minimalizovat cenu plánu.

\begin{definice}[Optimalizační úloha s jednou účelovou funkcí (\cite{AlgOptBook}, str. 5)]\label{df:optUloha1ucObecne}
  Optimalizační úloha s jednou účelovou funkcí je definována jako úloha nalezení $x^*$,
  \begin{align}
    x^* = \max_{x \in \mathcal{X}} \{ q(x) \},
  \end{align}
  kde $\mathcal{X}$ je množina všech možných konfigurací a $q \colon \mathcal{X} \rightarrow \mathbb{R}$ je účelová funkce.
\end{definice}

Návrh účelové funkce zásadně ovlivní, jaké $x$ je řešením.
Bez újmy na obecnosti můžeme účelovou funkci maximalizovat, protože
\begin{align*}
  \min_{x \in \mathcal{X}} \{ q(x) \} \equiv \max_{x \in \mathcal{X}} - \{ q(x) \}.
\end{align*}

Za \textit{optimální řešení optimalizační úlohy s jednou účelovou funkcí} se považuje optimální konfigurace $x^* \in \mathcal{X}$,
kde $q(x^*)$ je globální maximum $q$.
Optimální řešení nemusí být jenom jedno, může jich být více. Zároveň alespoň jedno optimální řešení vždy existuje.

\begin{definice}[Optimalizační úloha s více účelovými funkcemi]\label{df:optUloha2ucObecne}
  Optimalizační úloha s více účelovými funkcemi je definována jako úloha nalezení $x^*$,
  \begin{align*}
    x^* = \max_{x \in \mathcal{X}} \{ \mathbf{q}(x) \}, \hspace{50pt} &\mathbf{q}(x) = [q_1(x), q_2(x), \dots q_{m}(x)], q_i \in \mathcal{Q},
  \end{align*}
  pro $1 \leq i \leq m, m = |\mathcal{Q}|$,
  kde $\mathcal{X}$ je množina všech možných konfigurací a $\mathcal{Q}$ je množina všech účelových funkcí, které chceme maximalizovat.
  Víceúčelovou funkci $\mathbf{q}(x)$ maximalizujeme po složkách.
\end{definice}
Z definice \ref{df:optUloha2ucObecne} je \textit{optimálním řešením optimalizační úlohy s více učelovými funkcemi}
$x^* \in \mathcal{X}$ takzvaný \textit{utopia point} $y^{utopia}$ (\cite{AlgOptBook}, str. 219).
To je konfigurace, která nabývá optima pro každou jednotlivou účelovou funkci.
Zřejmě $y^{utopia}$ nemusí existovat, protože často maximalizování $q_i \in \mathcal{Q}$ může minimalizovat $q_j \in \mathcal{Q}, i \neq j$.
V nadcházející kapitole si ukážeme jak se optimalizace takového typu řeší.

V předchozí kapitole jsme si ukázali způsob, jakým nalezneme počet úspěšně odbavených incidentů $s$. 
Abychom mohli problém nalezení optimálního plánu modelovat jako optimalizační úlohu s více účelovými funkcemi, potřebujeme si ještě dodefinovat cenu plánu.
\begin{definice}[Cena plánu $u$]\label{df:cenaPlanu}
  Cena plánu $u \colon P \rightarrow \mathbb{N}$,
  \begin{align*}
    u(p) = \sum_{z \in Z} p_{D_l}(z) + |\{ a \in A \mid p_{A}(a) \neq v_{\emptyset} \}|.
  \end{align*}
  Cena plánu je součet všech dob trvání směn přiřazených záchranným týmům a počtu naalokovaných záchranných vozidel.
\end{definice}

Všimněme si, že $p_{D_l}(z) = 0$, pro nenaalokované týmy, čili nijak nepřispějí do výsledku sumy.

Nyní již máme všechny prostředky potřebné k tomu, abychom modelovali problém nalezení optimálního plánu jako optimalizační úlohu s více účelovýmí funkcemi. 
\begin{definice}[Optimalizační úloha nalezení optimálního plánu pohotovostní služby jako optimalizační úloha s více účelovými funkcemi]\label{df:optUloha2uc}
  Optimalizační úloha nalezení optimálního plánu pohotovostní služby jako optimalizační úloha s více účelovými funkcemi je úloha nalezení $p^*$,
  \begin{align*}
    p^* = \max_{p \in P_C} \{ \mathbf{q}(p) \}, \hspace{50pt} \mathbf{q}(p) = [s(p, I), -u(p)],
  \end{align*}

  kde $P_C$ je množina všech povolených plánu pohotovostní služby splňující omezení $C$ a $I$ je daná množina incidentů.
  Účelové funkce $s$ a $u$ jsou simulace plánu $p$ na $I$ a cena plánu $p$.
\end{definice}

Všimněmě si, že maximalizování $s$ bude velmi pravděpodobně vést k maximalizování $u$, tedy k minimalizování $-u$.
Plány úspěšně odbavující incidenty zřejmě budou používát více záchranných týmu s delšími směnami a více záchranných vozidel, takže budou dražší.
Z toho důvodu řešení $y^{utopia}$ nemusí existovat. Tímto problémem se zabýváme v následující kapitole.

\section{Metody pro řešení optimalizačního problému s více účelovými funkcemi}\label{kap:metodyProReseniOptSViceUcel}

V předchozí kapitole jsme problém nalezení optimálního plánu pohotovostní služby namodelovali jako optimalizační úlohu s více účelovými funkcemi (viz definice \ref{df:optUloha2uc}),
a to počtem úspěšně odbavených incidentů $s(p, I)$ a ceny plánu $u(p)$.
Zároveň jsme pozorovali, že maximalizováním $s$ minimalizujeme $-u$ a naopak.

Optimalizační úlohy s více účelovými funkcemi, mezi kterými je potřeba nalézt kompromis pro nalezení optima, jsou velmi časté,
a proto existuje několik metod, které optimalizační úlohy s více účelovými funkcemi řeší.
Jednou z účinných metod je převod víceúčelové funkce na jednu účelovou funkci, aby
zároveň maximalizování víceúčelové funkce bylo stejné jako maximalizování jedné účelové funkce.

Řešení optimalizační úlohy s jednou účelovou funkcí je dobře definované,
narozdíl od řešení optimalizační úlohy s více účelovými funkcemi.
V této kapitole si ukážeme vybrané metody.

\subsection{Lexikografické porovnání}

Jedná se o způsob převedení víceúčelové funkce pouze na jednu účelovou funkci, kde konfigurace porovnáváme lexikograficky podle nějaké permutace jednotlivých účelových funkcí,
která určuje jejich prioritu nad ostatními.

\begin{definice}[lexikografické porovnání]\label{df:lexPorovnani}
  Účelová funkce $q$ porovnávájící $x_1, x_2 \in \mathcal{X}$ lexikograficky podle permutace $\pi \in S_m$ je definovaná:
  \begin{align*}
    q(x_1) < q(x_2) \Leftrightarrow \bigvee_{k=1}^m \left ( \left ( \bigwedge_{i=1}^{k-1} q_{\pi(i)}(x_1) = q_{\pi(i)}(x_2) \right ) \land q_{\pi(k)}(x_1) < q_{\pi(k)}(x_2) \right )
  \end{align*}
  a 
  \begin{align*}
    q(x_1) = q(x_2) \Leftrightarrow q_{\pi(i)}(x_1) = q_{\pi(i)}(x_2), \forall i \in \{ 1, \dots, m \}.
  \end{align*}
\end{definice}

Jedná se o optimalizaci po jednotlivých účelových funkcích podle určené priority. 
Obecně není vhodná, protože neumí nalézt kompromis mezi jednotlivými účelovými funkcemi a obecně nemusí být jasné, jaké účelové funkce preferovat.

\subsection{Vážená suma účelových funkcí}\label{kap:vazenaSumaUcelF}

Jedná se o způsob převedení víceúčelové funkce pouze na jednu účelovou funkci pomocí sumy účelových funkcí pronásobené váhami.

\begin{definice}[Vážená suma účelových funkcí (\cite{AlgOptBook}, str. 218)]\label{df:vazenaSumaUcelF}
  Vážená suma účelových funkcí $q'$ je definovaná jako
  \begin{align*}
    q'(x) = w^T \mathbf{q}(x),
  \end{align*}
  kde $w \in \mathbb{R}^m$ je vektor vah.
\end{definice}

Tato metoda už umí nalézt kompromis mezi jednotlivými účelovými funkcemi, a to podle vah $w$.
Stejně ale jako u lexigrafického porovnání nemusí být obecně jasné, jaké účelové funkce preferovat.

\subsection{Goal programming}\label{kap:goalP}

Jedná se o způsob převedení víceúčelové funkce pouze na jednu účelovou funkci minimalizováním vzdálenosti od nějaké ideální hodnoty -- cíle. 

\begin{definice}[Účelová funkce měřící vzdálenost od cíle (\cite{AlgOptBook}, str. 219)]\label{df:goalP}
  \begin{align*}
    \min_{x \in \mathcal{X}} \{ \| \mathbf{q}(x) - y^{goal} \| \}, \hspace{50pt} y^{goal} \in \mathbb{R}.
  \end{align*}
\end{definice}

Standardně $y^{goal} = \mathbf{q}(y^{utopia})$ (\cite{AlgOptBook}, str. 219).
Zvolením vhodné normy můžeme preferovat námi vybrané účelové funkce, ale obodně jako u předchozích metod, obecně nemusí být jasné, jaké účelové funkce preferovat.
Zvolením normy jako nějaké $p$-normy (například standardní euklidovské normy), budou účelové funkce implicitně preferovány podle toho,
v jakých jednotkách se měří. Tudiž při maximalizaci budou preferovány účelové funkce s oborem hodnot ve větším rozsahu.

\subsection{Vážená exponenciální suma účelových funkcí}\label{kap:vazenaSumUcF}

Jedná se o kombinaci goal programming a vážené sumy účelových funkcí.
Váhami $w$ jsme schopni určit, kterou účelovou funkci je pro nás důležitější optimalizovat a parametrem $\varphi$ jakou $\varphi$-normu chceme použít.

\begin{definice}[Vážená exponenciální suma účelových funkcí (\cite{AlgOptBook}, str. 219)]\label{df:vazenaSumUcF}
  \begin{align*}
    q(x) = \sum_{i=1}^{m} w_i (q_i(x) - y_i^{goal})^\varphi,
  \end{align*}
  kde $w \in \mathbb{R}^m, \varphi \in \mathbb{R}$.
\end{definice}

Může být příjemnější na použití než goal programming, protože místo škálování prostoru normou škálujeme jednotlivé hodnoty účelové funkce.

\section{Převedení problému na optimalizační úlohu s jednou účelovou funkcí}\label{kap:opt1Uc}

Nadefinovali jsme účelové funkce $s$ a $u$ a problém nalezení optimálního plánu jako optimalizační úlohu s více účelovými funkcemi $s$ a $u$.
Pro optimalizační úlohy s více účelovými funkcemi obecně nemusí existovat optimum.
Proto jsme si v předchozí kapitole ukázali několik přístupů,
které vhodně převedou optimalizační úlohu s více účelovými funkcemi na optimalizační úlohu s jednou účelovou funkcí.
Pro optimalizační úlohu s jednou účelovou funkcí již alespoň jedno optimum vždy existuje.

V této kapitole si ukážeme, jak optimalizační úlohu nalezení optimálního plánu pohotovostní služby s více účelovými funkcemi (viz definice \ref{df:optUloha2uc}) převést na
optimalizační úlohu nalezení optimálního plánu pohotovostní služby s jednou účelovou funkcí, pomocí metod zmíněných v předchozí kapitole.

K tomu si je ještě potřeba první dodefinovat přeškálované účelové funkce do intervalu $\langle 0, 1 \rangle$, aby
bylo možné výsledné účelové funkce definovat přehledněji.
\begin{definice}[Přeškálování $s$ do intervalu $\langle 0, 1 \rangle$ ] \label{df:simulaceSkal}
  Definujme $s'$ jako přeškálování $s$ do intervalu $\langle 0, 1 \rangle$,
  \begin{align*}
    s'(p, I) = s(p, I) / |I|.
  \end{align*}
\end{definice}
\begin{definice}[Přeškálování $u$ do intervalu $\langle 0, 1 \rangle$ ] \label{df:cenaPlanuSkal}
  Definujme $u'$ jako přeškálování $u$ do intervalu $\langle 0, 1 \rangle$,
  \begin{align*}
    u'(p) = u(p) / K,
  \end{align*}
  kde $K$ je maximální možná cena plánu,
  \begin{align*}
    K = Z_n \cdot \max_{d_l} \{ d_s \} + A_n,
  \end{align*}
  naalokování nejdelší směny na všechny týmy záchranářů a naalokování všech záchranných vozidel.
\end{definice}

Nyní už si můžeme ukázat jak vypadají jednotlivé účelové funkce optimalizace pohotovostního plánu.
Začneme aplikováním lexikografického porovnání (viz definice \ref{df:lexPorovnaniPohotovost}) na náš problém následovně.
\begin{definice}[Lexikografické porovnávání optimalizace pohotovostního plánu]\label{df:lexPorovnaniPohotovost}
  Lexikografické porovnávání optimalizace pohotovostního plánu $q^{\text{Lex}}$ definujeme jako
  \begin{align*}
    & q^{\text{Lex}}(p_1) < q^{\text{Lex}}(p_2)\Leftrightarrow\\
    & ( s(p_1, I) < s(p_2, I)) \lor (s(p_1, I) = s(p_2, I) \land u(p_1) < u(p_2))
  \end{align*}
  a 
  \begin{align*}
    q^{\text{Lex}}(p_1) = q^{\text{Lex}}(p_2) \Leftrightarrow s(p_1, I) = s(p_2, I) \land u(p_1) = u(p_2),
  \end{align*}
  pro danou množinu incidentů $I$.
\end{definice}

Pokud za účelovou funkci zvolíme $q^{\text{Lex}}$, tak optimální plán bude takový, že odbaví co nejvíce incidentů je možné, a z nich budou optimální ty nejlevnější plány:
\begin{alignat*}{2}
  \min_{p^* \in P} \{ u(p^*) \}, && \hspace{15pt} P = \{ p \mid \max_{p \in P_C} \{ s(p, I) \} \},
\end{alignat*}
pro danou množinu incidentů $I$.

Definovat $q^{\text{Lex}}$ obráceně nedává smysl, protože nejlevnější plán je prázdný plán a ten na množině incidentů $I$ nikdy neodbaví žádný incident.

Váženou sumu účelových funkcí (viz definice \ref{df:vazenaSumaUcelF}) aplikujeme na náš problém podle následující definice. 
\begin{definice}[Vážená suma účelových funkcí optimalizace pohotovostního plánu]\label{df:vazenaSumaPohotovost}
  Váženou sumu účelových funkcí optimalizace pohotovostního plánu $q_{\alpha}$ definujeme jako
  \begin{align*}
    q_{\alpha}(p) = \alpha \cdot s'(p, I) - (1 - \alpha) \cdot u'(p), \hspace{50pt} \alpha \in [0, 1], p \in P_C,
  \end{align*}
  pro danou množinu incidentů $I$, kde $w_1 = \alpha$ a $w_2 = 1 - \alpha$.
\end{definice}

Parametr $\alpha$ bychom preferovali blíže jedné, pro upřednostnění $s'$ a pro upřednostnění $u'$ blíže nule.

Metodu goal programming (viz definice \ref{df:goalP}) aplikujeme následovně.
\begin{definice}[Goal programming optimalizace pohotovostního plánu]
  Víceúčelovou funkci převedeme na jednu podle metody goal programming na účelovou funkci $q^{\text{Goal}}$ definovanou jako
  \begin{align*}
    q^{Goal}(p) = \| [1 - s'(p, I), u'(p)] \|,
  \end{align*}
  pro danou množinu incidentů $I$ a libovolnou normu.
\end{definice}

Pro pohotovostní plány nechť $p^{goal} \colon q(p^{utopia}) = [1, 0]$, úspěšné odbavení všech incidentů za nulovou cenu.
Samozřejmě $p^{utopia} \not \in P_C$, ledaže $|I| = 0$.

Nulovou cenu má pouze plán, kde není naalokován žádný tým záchranářů ani záchranné vozidlo a takový plán nemůže úspěšně obsloužit žádný incident. 
Můžeme však měřit, jak blízko $q(p)$ k $q(p^{utopia})$ je.

Jako poslední aplikujeme na náš problém metodu vážené exponenciální sumy účelových funkcí (viz definice \ref{df:vazenaSumUcF}).
\begin{definice}[Vážená exponenciální suma účelových funkcí optimalizace pohotovostního plánů]\label{df:vazenaSumaExpPohotovost}
  Váženou exponenciální sumou účelových funkcí optimalizace pohotovostního plánů $q_{\alpha}^{\varphi}$ definujeme jako 
  \begin{align*}
    q_{\alpha}^{\varphi}(p) = \alpha (1 - s'(p, I))^\varphi + (1 - \alpha)(u'(p))^\varphi, \hspace{50pt} p \in P_C,
  \end{align*}
  pro danou množinu incidentů $I$, kde $w_1 = \alpha$ a $w_2 = 1 - \alpha$.
\end{definice}

Stejně jako u vážené sumy účelových funkcí jsme díky parametru $\alpha$ schopni upřednostit maximalizování $s'$ nad $-u'$.

Nyní máme prostředky pro definování problému nalezení optimálního pohotovostního plánu jako optimalizační úlohy s jednou účelovou funkcí.

Označme si $Q_I = \{ q^{\text{Lex}}, q^{\text{Goal}}, q_{\alpha}, q_{\alpha}^{\varphi}\}$ jako množinu účelových funkcí na dané množině incidentů $I$.
\begin{definice}[problém nalezení optimálního plánu jako optimalizační úloha s jednou účelovou funkcí]\label{df:optUloha1uc}
  Optimalizační úloha nalezení optimálního plánu pohotovostní služby s jednou účelovou funkcí je definována jako úloha nalezení $p^*$,
  \begin{align}
    p^* = \max_{p \in P_C} \{ q(p) \},
  \end{align}
  kde $q \in Q_I$.
\end{definice}

\section{Analýza optimalizační úlohy}

V předchozí kapitole se nám podařilo problém nalezení optimálního plánu namodelovat jako optimalizační úlohu s jednou účelovou funkcí,
pomocí metod diskutovaných v kapitole \ref{kap:metodyProReseniOptSViceUcel}.
V této kapitole klasifikujeme o jakou optimalizační úlohu se jedná zkoumáním účelové funkce a množiny plánů.
Zklasifikováním optimalizační úlohy budeme moct použít metodiky, které se standardně pro řešení takových úloh využívají. 
Podrobněji jsou diskutovány v kapitole \ref{chap:reseniOptUloh}.

\subsection{Analýza množiny plánů pohotovostních služeb}\label{kap:analP}

Spočítejme velikost množiny plánů pohotovostních služeb $P$ a $P_C$.
Znát velikosti těchto množin je klíčové pro navrhování metod pro nalezení optima.
To hlavně platí pro $P_C$, jelikož námi hledané optimum právě $P_C$ náleží.
Jaké implikace má velikost $P_C$ na zvolené metody řešení je popsáno v kapitole \ref{kap:NP}.

\begin{veta}[Velikost množiny plánů pohotovostních služeb]\label{veta:velikostP}
  Velikost plánu pohotovostní služby $P$ je rovna:
  \begin{align*}
    \sum_{i = 0}^{Z_n} {D_n}^{\binom{Z_n - i + V_n - 1}{V_n - 1}} \cdot \sum_{i = 0}^{A_n} {\binom{A_n - i + V_n - 1}{V_n - 1}}.
  \end{align*}
\end{veta}

\begin{dukaz}
  Všimněme si, že počet uspořádaných $V_n$-tic nezáporných celých čísel posčítajících se na $k$
  a záleží na pořadí sčítanců přesně odpovídá počtu naalokování záchranných týmů na výjezdové stanice, kde chceme naalokovat přesně $k$ týmů.
  Například pro $k = 10$ a $V_n = 4$ by

  \begin{align*}
    3 + 0 + 5 + 2 = 10
  \end{align*}

  odpovídalo naalokování 3 týmů na první stanici, 0 na druhou, 5 na třetí a dva na čtvrtou.
  Podle lemma o počtu uspořádaných $r$-tic nezáporných celých čísel, které se posčítají na $m$, přičemž záleží na pořadí~(\citet{Diskretka}, (2.3), str. 61),
  víme, že takových uspořádaných $V_n$-tic je

  \begin{align}
    \binom{k + V_n - 1}{V_n - 1}.
  \end{align}

  Přesčítáním přes všechny $k \in \{ 0, \dots, Z_n \}$ tak spočítáme sumu všech naalokování přes $k$ týmů záchranářů, které jsou navzájem disjunktní, takže žádnou alokaci týmů nesčítáme vícekrát.
  Každému týmu záchranářů v rámci alokace je ještě přiřazena pracovní směna, těch je $D_n$, proto $D_n$ umocňujeme. 

  Pro alokování záchranných týmů analogicky, akorát nepřiřazujeme pracovní směny.
\end{dukaz}

\begin{veta}[Velikost množiny plánů pohotovostních služeb splňující omezení $C$]
  Velikost plánu pohotovostní služby $P_C$ splňující omezení $C$ je rovna:
  \begin{align*}
    \sum_{i=0}^{Z^c_n}{{D_n}^{\binom{Z^c_n - i + V_n - 1}{V_n - 1}}} \cdot \sum_{i = 0}^{A^c_n}\binom{A^c_n - i + V_n - 1}{V_n - 1},
  \end{align*}

  kde
  \begin{align*}
    Z^c_n = \sum_{i=1}^{V_n} c_{z_{i}}, A^c_n = \sum_{i=1}^{V_n} a_{z_{i}}.
  \end{align*}
\end{veta}

\begin{dukaz}
  Stejný jako v předchozí větě, akorát místo, abychom vybírali ze všech záchranných týmu a vozidel,
  vybíráme ze součtu přes korespondující dostupné kapacity na výjezdových stanicích $Z^c_n$ a $A^c_n$.
\end{dukaz}

\begin{veta}[Asymptotický odhad velikosti množiny plánů pohotovostních služeb]\label{veta:asymptotP}
  Nechť $P$ množina plánu pohotovostních služeb. Pak 

  \begin{align*}
    |P| \in \mathcal{O} \left ({D_n}^{2^{Z_n + V_n}} \cdot 2^{A_n + V_n} \right ).
  \end{align*}
\end{veta}

\begin{dukaz}
  Odhadněme s pomocí identity kombinačního čísla~(\citet{Diskretka}, (2.4), str. 62) a binomické věty~(\citet{Diskretka}, (2.6), str. 63),

  \begin{align*}
    \sum_{i=0}^{n} \binom{n - i + V_n - 1}{V_n - 1} =
    \sum_{i=0}^{n} \binom{n - i + V_n - 1}{n - i} \leq
    \sum_{i=0}^{n} \binom{n + V_n - 1}{n - i} =
    2^{n + V_n - 1}
  \end{align*}

  a dosaďmě do věty \ref{veta:velikostP} pro $n = Z_n$, $A_n$,
  \begin{align*}
    |P| \leq {D_n}^{2^{Z_n + V_n - 1}} \cdot 2^{A_n + V_n - 1},
  \end{align*}
  takže,
  \begin{align*}
    |P| \in \Theta({D_n}^{2^{Z_n + V_n}} \cdot 2^{A_n + V_n}).
  \end{align*}
  Odhad má chybu nanejvýš $n^2$.
\end{dukaz}

\begin{veta}[Asymptotický odhad velikosti množiny plánů pohotovostních služeb splňující omezující podmínky]\label{veta:PCvelikost}
  Nechť $P_C$ množina plánu pohotovostních služeb splňující omezující podmínky $C$. Pak 

  \begin{align*}
    |P_C| \in \Theta({D_n}^{2^{Z^c_n + V_n}} \cdot 2^{A^c_n + V_n}).
  \end{align*}
\end{veta}

\begin{dukaz}
  Analogicky jak důkaz věty \ref{veta:asymptotP}, dosadíme $n = Z^c_n, A^c_n$.
\end{dukaz}

\subsection{Analýza účelové funkce}\label{kap:analVicF}

V této kapitole se zaměříme na vlastnosti účelové funkce.
První si zanalyzujeme vlastnosti simulaci $s$ a z toho vyplynou vlastnosti o účelové funkci, jelikož účelová funkce je jejím složením s cenou.
Jaké implikace mají vlastnosti účelové funkce na zvolené metody řešení je diskutováno v kapitole~\ref{chap:reseniOptUloh}.

\begin{veta}[Vlastnosti simulace $s$]\label{veta:vlastnostiSim}
  Simulace $s$ není spojitá a derivovatelná.
\end{veta}

\begin{dukaz}
  Definiční obor přiřazujících funkcí $p_Z$, $p_A$, $p_{D_{1}}$, $p_{D_{2}}$, jsou množiny $Z$, $A$, $D_s$, $D_l$, obsahující konečný počet objektů.
  Plán $p$ je jednoznačně určen přiřazujícími funkcemi, takže i $P$ je konečná množina.
  Definiční obor $s$ je množina plánů $p \in P_C$, čili definiční obor funkce $s$ je konečná množina, a tak $s$ nemůže být spojitá funkce.
  Jelikož $s$ není spojitá, nemůže být ani derivovatelná.

  Argumentů pro nederivovatelnost je více, například $s$ nemá žádný matematický předpis, nebo že $P_C$ je diskrétní množina.
\end{dukaz}

\begin{veta}[Vlastnosti účelových funkcí $Q_I$]\label{veta:nespANedevQ}
  Účelové funkce $q \in Q_I$ nejsou spojité a derivovatelné.
\end{veta}

\begin{dukaz}
  Víceúčelové funkce $q \in Q_I$ které budeme maximalizovat jsou jen jednoduchou kombinací původních účelových funkcí $s$ a $u$, podle definice \ref{df:optUloha1uc}.
  Z věty \ref{veta:vlastnostiSim} víme, že $s$ není spojitá ani derivovatelná.
  Tím pádem i $q \in Q_I$ není spojitá ani není derivovatelná.
\end{dukaz}

\subsection{Naivní řešení}\label{kap:naivniRes}

V této kapitole se podíváme na přímočarý způsob, jak nalézt optimální plán pohotovostní služby. 
Jednoduše zkusíme účelovou funkci $q \in Q_I$ vyhodnotit ve všech bodech, tedy všech plánech $p \in P_C$.
Ukáže se, že takové přímočaré naivní řešení je velmi neefektivní. Sofistikovanější způsoby řešení našeho problému jsou diskutovány v kapitole \ref{chap:reseniOptUloh}.

\begin{definice}[Naivní řešení]\label{df:naivniRes}
  Naivní řešení problému nalezení optimálního plánu pohotovostní služby znamená vyhodnocení $q \in Q_I$ ve všech bodech $p \in P_C$,
  kde si v průběhu vyhodnocování držíme $p^* \in P_C$ doposud s maximální hodnotou $q(p^*)$.

  Po vyhodnocení ve všech bodech $p$, tak $p^*$ bude optimem, protože $q(p^*) \geq p, \forall p \in P_C$.
\end{definice}

\begin{veta}[Složitost naivního řešení]\label{veta:slozitostNaivRes}
  Složitost naivního řešení je

  \begin{align*}
    \Theta((A_n + Z_n |I|) \cdot {D_n}^{2^{Z^c_n + V_n}} \cdot 2^{A^c_n + V_n}),
  \end{align*}
  kde $\Theta (A_n + Z_n |I|)$ je složitost vyhodnocení $q \in Q_I$.
\end{veta}
\begin{dukaz}
  Z definice naivního řešení \ref{df:naivniRes} potřebujeme vyhodnotit $q$ ve všech bodech $p \in P_C$.
  Účelová funkce $q$ je konstantní kombinací funkcí simulace $s$ a ceny plánu $u$. Složitost vyhodnocení $u$ je

  \begin{align*}
    \Theta (Z_n + A_n).
  \end{align*}

  To plyne přímo z definice $u$ \ref{df:cenaPlanu}. Složitost vyhodnocení $s$ je

  \begin{align*}
    \Theta (Z_n \cdot |I|).
  \end{align*}

  Z definice $s$ \ref{kap:definiceSimulace} nahlédneme, že potřebujeme pro každý incident, těch je $|I|$, nalézt nejvhodnější tým záchranářů.
  Nejvhodnější tým záchranářů nalezneme pro $i \in I$ v čase $Z_n$, protože potřebujeme všechny týmy proiterovat a práce na jeden tým už považujeme za konstantní. 

  Vyhodnocení účelové funkce $q$ má pak složitost

  \begin{align*}
    \Theta (Z_n + A_n + Z_n |I|) = \Theta (A_n + Z_n |I|).
  \end{align*}

  Potřebujeme vyhodnotit $q$ pro každý plán $p \in P_C$.
  Asymptotický odhad velikosti množiny $P_C$ je 

  \begin{align*}
    \Theta ({D_n}^{2^{Z^c_n + V_n}} \cdot 2^{A^c_n + V_n}),
  \end{align*}

  z věty \ref{veta:asymptotP}. Z toho již plyne složitost naivního řešení z věty.
\end{dukaz}

Naivní řešení běží v exponenciálním čase, protože prostor plánů $P_C$ je exponenciálně velký, takže už i samotný průchod běží v exponenciálním čase.
Chtěli bychom nalézt způsob, kterým nalezneme optimum ideálně v polynomiálním čase, nebo alespoň ne v exponenciálním čase.

\subsection{Klasifikace optimalizační úlohy}\label{kap:NP}

V kapitole \ref{kap:analP} jsme přesně spočítali velikost $P$ a $P_C$ a zároveň jsme je odhadli asymptoticky.
V kapitole \ref{kap:analVicF} jsme si ukázali základní vlastnosti účelové funkce $q \in Q_I$.
V předchozí kapitole jsme si ukázali, že nemůžeme úlohu vyřešit jednoduše naivním řešením v polynomiálním čase.
V této kapitoly dáme tyto poznatky dohromady a zklasifikujeme tak řešenou optimalizační úlohu, za účelem nalezení nejvhodnějších metod pro řešení.

Vybíráme optimální konfigurace z diskrétně konečně mnoho objektů, a to sice přiřazení $p_Z$, $p_A$, $p_{D_{s}}$, $p_{D_{l}}$.
Jedná se tak o \textit{diskrétní} nebo taky \textit{kombinatorickou} optimalizaci \cite{discrete}.
To je takový druh optimalizace, kdy se snažíme nalézt optimální konfiguraci z diskrétně mnoho možností.

\textit{Spojitá} optimalizace je typ optimalizace, kde prohledávané konfigurace jsou spojité \cite{continuos}.

Z věty \ref{veta:nespANedevQ} víme, že $q \in Q_I$ není spojitá ani derivovatelná, takže metodami pro řešení spojitých optimalizačních úloh se nebudeme zabývat.

Podívejme se na úspěšnou metodu nalezení optima v kombinatorické optimalizci, sice lineární programování \cite{LP}.
Problém formulovaný jako lineární program lze vyřešit v polynomiálním čase \cite{cohen2020solving}.

\begin{definice}[Formulace problému pro lineární programování (\cite{AlgOptBook}, str. 189)]
  \begin{align*}
    \max_{x \in \mathcal{X}} c^T x,
  \end{align*}

  kde $x$ splňuje
  \begin{alignat*}{2}
    & {w^1}^T_i x \leq b_i, && \hspace{20pt} i \in \{ 1, 2, \dots \},\\
    & {w^2}^T_j x \geq b_j, && \hspace{20pt} j \in \{ 1, 2, \dots \},\\
    & {w^3}^T_k x = b_k,    && \hspace{20pt} k \in \{ 1, 2, \dots \},
  \end{alignat*}
  kde $c$ je vektor, reprezentující lineární účelovou funkci.
\end{definice}

Náš problém ale nelze vyjádřit v takovém tvaru, především z důvodu navrhnutí účelové funkce.
Účelová funkce $q \in Q_I$ je složením se simulací $s$. Simulace $s$ nemá žádný matematický předpis.
Použití simulace tak nevylučuje jenom lineární programování, ale obecně všechny metody, kde je potřeba optimalizační úlohu vyjádřit jako
soustavu rovnic nebo nerovnic, které ani nemusí být lineární.
Použití simulace je pro nás ale žádoucí, důvody proč jsou diskutovány v kapitole \ref{kap:procSimulace}.

Dále bychom chtěli pro problém nalezení optimálního plánu zjistit, do jaké třídy složitosti náleží. 
Ukažme si první, do jaké třídy složitosti náleží optimalizační úloha, na jejíž účelovou funkci dáme omezení.

\begin{definice}[Optimalizační úloha s černou skříňkou $Q$]\label{df:Q}
  Nechť $\mathcal{X} \colon |\mathcal{X}| \in \Theta(2^n)$ množina všech možných konfigurací a $q \colon X \rightarrow \{ 1, 2, \dots, n \}, n \in \mathbb{N}$.
  Jako optimalizační úlohu s černou skříňkou rozumíme optimalizační úlohu
  \begin{align*}
    \max_{x} q(x), \hspace{50pt} x \in \mathcal{X},
  \end{align*}
  kde $\forall x_1, x_2 \in \mathcal{X}$ jsme schopni zjistit zda platí $q(x_1) \leq q(x_2)$ jedině vyhodnocením $q$ v $x_1$,
  $q$ v $x_2$ a následným porovnáním vyhodnocených hodnot, $q(x_1) \leq q(x_2)$.
  Vyhodnocení $q$ může být nejhůř polynomiální vůči oboru hodnot $q$.
  Takové funkci $q$ budeme říkat černá skříňka.

  Označme problém optimalizační úlohy s černou skříňkou $Q$.
  Odpověď $Q(y)$ je rovna optimu $x^*$, pro libovolný vstup problému $y$.
\end{definice}

\begin{definice}[Rozhodovací problém černé skříňky $R$]\label{df:R}
  Nechť $\mathcal{X} \colon |\mathcal{X}| \in \Theta(2^n)$ množina všech možných konfigurací a $q \colon X \rightarrow \{ 1, 2, \dots, n \}, n \in \mathbb{N}$,
  kde $q$ je černá skříňka.
  Jako rozhodovací problém černé skříňky rozumíme otázku, zda
  \begin{align*}
    \exists x \in \mathcal{X} \colon q(x) = k, \hspace{50pt} x \in \mathcal{X},
  \end{align*}
  kde $k \in \{ 1, 2, \dots, n \}$.

  Označme rozhodovací problém černé skříňky $R$.
  Pokud existuje, $R(y) = 1$, jinak $R(y) = 0$, pro libovolný vstup problému $y$. 
\end{definice}

\begin{veta}[Rozhodovací problém černé skříňky je NP-úplný]\label{veta:R_NPup}
  Problém $R$ je NP-úplný.
\end{veta}

\begin{dukaz}
  Zaprvé dokážeme, že problém $R$ náleží třídě NP.
  Řekněme, že nějaký algoritmus $A$ tvrdí, že $x \in \mathcal{X}$ je řešením problému $R$.
  Vyhodnocením $q$ v $x$ ověříme, jestli $q(x) = k$, tedy $A(x) = R(x)$.
  Vyhodnocení $q$ trvá nejhůře polynomiálně dlouho vůči $n$, takže $R$ náleží NP.

  Zadruhé ukážeme převod problému \textit{SAT} na $R$: $\text{\textit{SAT}} \rightarrow R$.
  Problém \textit{SAT} je NP-úplný. Převodem tak dokážeme, že problém $R$ je alespoň tak těžký, jako problém \textit{SAT}, takže je alespoň NP-úplný.

  Nechť klauzule v konjuktivním normálním tvaru $\phi$ problému \textit{SAT} o $n$ literálech.
  Nechť $\mathcal{X} = \text{množina všech možných ohodnocení \phi}$.

  Funkci $q$ definujme $q(x) = \phi(x)$.
  Hledané $k$ tak bude 1, splění formule.
  Takto definovaná funkce $q$ je černá skříňka, protože pro libovolné ohodnocení $x_1,x_2 \in \mathcal{X}$ musíme $\phi$ vyhodnotit, abychom zjistili ohodnocení $\phi$.
  Nejsme schopni na základě $q(x_1)$ určit ohodnocení $q(x_2)$, pro libovolné ohodnocení $x_1, x_2 \in \mathcal{X}$, takže ani $q(x_1) \leq q(x_2)$.

  Takže $x \in \mathcal{X}$ takové, že $q(x) = \phi(x) = 1$, je
  hledané splnitelné ohodnocení formule $\phi$ a sestrojili jsme tak převod mezi problémem \textit{SAT} a problémem $R$. 

  Ukázali jsme, že problém $R$ náleží třídě NP a zároveň jsme sestrojili převod NP-úplného problému na problém $R$.
  Jelikož jsou všechny NP-úplné problémy navzájem převoditelné, tak i problém $R$ je NP-úplný.
\end{dukaz}

\begin{veta}[Optimalizační úloha s černou skříňkou je NP-těžký problém]\label{veta:cernaSkrinkaNP}
  Problém $Q$ je NP-těžký problém.
\end{veta}

\begin{dukaz}
  Víme, že problém $R$ je NP-úplný (viz věta \ref{veta:R_NPup}). Nyní dokážeme, že problém $Q$ je NP-těžký.
  První sestrojíme převod mezi problémy $R$ a $Q$: $R \rightarrow Q$, a tím ukážeme, že $Q$ je alespoň tak těžký jak $R$.
  Zadruhé ukážeme, že problém $Q$ není NP-úplný.
  Z obojího plyne, že problém $Q$ je NP-těžký, podle definice NP-těžkosti.

  Nechť rozhodovací problém černé skříňky $R$, kde nás zajímá, zda existuje $x$ pro které $q(x) = k, k \in \{ 1, \dots, n\}$. 
  Nechť optimalizační problém s černou skříňkou $Q$, kde z definice hledáme optimum $x^*$ černé skříňky $q'$.
  Definujme $q'(x) = $
  \[
  \begin{cases}
    q(x), & \text{je-li $q(x) \leq k$},\\
    k - 1, & \text{jinak}.
  \end{cases}
  \]
  Pokud $q'(x^*) = k$, pak existuje $x$ takové, že $q(x) = k$, a to například právě optimum $x^*$.
  Pokud $q'(x^*) = l, l \neq k$, pak neexistuje $x$ takové, že $q(x) = k$, protože $l < k$ a zároveň $x^*$ je optimální.
  Takže pro nalezené optimum $x^*$ platí $q'(x^*) = k$ právě tehdy, když existuje $x \in \mathcal{X}$ takové, že $q(x) = k$.
  Tím jsme sestrojili převod $R \rightarrow Q$.

  Zadruhé ukažme, že problém $Q$ není NP-úplný.
  Nechť algoritmus $A$ řešící problém $Q$.
  Nechť $x^*$ optimální podle $A$. Jak ověříme, že $x^*$ je skutečně optimální, tedy $Q(x) = x^*$?
  Z definice nesmí existovat $x' \colon q(x') > q(x^*)$.
  Abychom ověřili, že takové $x'$ skutečně neexistuje, musíme projít všechna $x \in \mathcal{X}$ a ověřit, že $q(x) \leq q(x^*)$.
  Jiným způsobem, než průchodem $\mathcal{X}$ to nemůžeme zjistit, protože $q$ je černá skříňka.
  Jenže $|\mathcal{X}| = 2^n$, průchod trvá $2^n$, čili hůře než polynomiálně vůči $n$.

  Na optimalizační problém s černou skříňkou $Q$ jsme převedli NP-úplný rozhodovací problém černé skříňky $R$ a zároveň
  problém $Q$ není NP-úplný, takže problém $Q$ je NP-těžký.
\end{dukaz}

Pojďme si propojit optimalizační problém s černou skříňkou (viz definice \ref{df:Q}) s našim problémem (viz definice \ref{df:optUloha1uc}). 

Optimalizační úloha nalezení optimálního plánu pohotovostní služby používá účelovou funkci $q \in Q_I$.
Účelová funkce $q$ je složením se simulací $s$.
Její předpis je dán průběhem simulace a vyhodnocení $s(p, I)$ závisí na průběhu simulace pohotovostního plánu na množině incidentů.
Simulace je velmi komplikovaná a i když v podstatě známe její předpis (viz algoritmus \ref{simulaceAlgo}),
tak nalézt nějaké vztahy, díky kterým budeme schopni ze znalosti $s(p_1)$ zjistit $s(p_1) \leq s(p_2)$ pro $\forall p_1, p_2 \in P_C \colon p_1 \neq p_2$ není vůbec snadné.
Dává tak smysl na simulaci nahlížet jako na černou skíňku.

\begin{veta}[Simulace jako černá skříňka]\label{veta:simulaceJakoCernaSkrinka}
  Nechť optimalizační úloha plánu pohotovostní služby $O$ používající účelovou funkci $q$, kde $q$ je složením se simulací $s$.
  Pokud předpokládáme, že $s$ je černá skříňka, pak $O$ je NP-těžká úloha.
\end{veta}

\begin{dukaz}
  Na úlohu $O$ se můžeme dívat jako na konkrétní instanci problému $Q$.
  Účelovou funkci $Q$ zvolíme jako $q \in Q_I$, využívající simulaci, množinu $\mathcal{X}$ zvolíme jako $P_C$.
  Z věty \ref{veta:PCvelikost} je velikost $P_C$ exponenciálně závislá na oboru hodnot $q$ a zároveň z předpokladu je černou skříňkou. 
  Podle věty \ref{veta:cernaSkrinkaNP} je problém $Q$ NP-těžký, úlohu $O$ jsme zformuvali jako problém $Q$, takže i $O$ je NP-těžké.
\end{dukaz}

Důsledek věty je, že pokud bychom chtěli úlohu $O$ vyřešit v polynomiálním čase,
tak na simulaci nesmíme nahlížet jako na černou skříňku.
Budeme minimálně potřebovat umět nalézt nějaké vztahy mezi $p_1, p_2 \in P_C$, díky kterým budeme schopni zjistit $q(p_1) \leq q(p_2)$
a najít pomocí těchto vztahů optimální plán, aniž bychom museli $q$ vyhodnotit přes celý její definiční obor.
Jedná se ale pouze o nutnou podmínku, nikoliv postačující. Čili pokud nalezneme nějaké vztahy mezi $p_1, p_2$ a nebudeme na simulaci nahlížet jako na černou skříňku,
neznamená to, že je nutně úloha optimálních plánů pohotovostních služeb řešitelná v polynomiálním čase.
O nalezení takových vztahů se pokusíme v kapitole \ref{kap:dynamicProgram}. Metody, které na účelovou funkci pohlíží jako na černou skříňku zkoumáme v kapitole \ref{kap:heuristiky}.


