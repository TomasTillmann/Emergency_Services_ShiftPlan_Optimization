\chapter{Převedení na optimalizační úlohu}

\section{Popis problému}

Pohotovostní služba vlastní pohotovostní vozidla, rozmístěná na výjezdových stanicích umístěných na území, které pohotovostní služba pokrývá.
Na každé výjezdové stanici působí několik záchranářu. Ti jsou v případě pohotovosti připraveni obsloužit vozidlo na výjezdové stanici a vyjet na místo incidentu.
Na výjezd je potřeba více záchranářu. Vždy je nutný řidič a kvalifikovaný lekář. Často je však i potřeba pomocné záchranáře.
Toto seskupení považujeme za tým záchranářů.
Tým záchranářů společně se záchraným vozidlem považujeme za záchranou jednotku.
Plán pohotovostní služby je alokace záchranných vozidel a týmů záchranářů na konkrétní výjezdové stanice a přiřazení pracovní služby každému týmu záchranářů v rámci jednoho dne.
\\\\
Pohotovostní plány mají různou kvalitu. Kvalita plánu se odvíjí od počtu incidentů, které byli úspěšně odbaveny a celkových vynaložených nákladů.
Incident je úspěšně odbaven, pokud v čase incidentu je k dispozici záchranná jednotka potřebná pro odbavení incidentu a zároveň jednotka dorazila včas na místo incidentu.
Pokud v čase incidentu neexistuje záchranná jednotka splňující tyto podmínky, tak incident považujeme za neúspěšně odbaven.
S roustoucím počtem úspěšně odbavených plánu roste i kvalita plánu.
Vynaložená cena se odvíjí od počtu záchranných vozidel aktivně naalokovaných zácrahnných vozidel a týmu. Tým s přiřazenou delší pracovní směnou je dražší.
Cena plánu bychom rádi minimalizovali, ne však na úkor úspěšnosti odbavení incidentů nebo efektivity plánu.
\\\\
Kvalita pohotovostního plánu se tedy odvíjí od počtu úspěšně odbavených incidentů a celkové ceny plánu.
Přirozeně vyvstává otázka, jakým způsobem najít ten nejkvalitnější plán, za účelem dosáhnutí co největší úspěšnosti za co nejméně zbytečně vynaložených zdrojů? 
Pro odpověď je první nutno problém formalizovat.

\clearpage

\section{Formalizace problému}

Mějme množinu všech dovolených plánů pohotovostních služeb $P$ a libovolnou množinu incidentů $I \sim \mathcal{I}$, kde $\mathcal{I}$ je distribuce incidentů. 
Definujme funkci určující kvalitu plánu $q_I\colon P \rightarrow \mathbb{R}$ pro $I$.
Chceme najít takové $p* \in P$, pro které platí:

$$
q_I(p*) \geq q_I(p), \forall p \in P
$$
.
\\
\\
Chceme najít plán $p$ pro který nabývá funkce $q_I$ globální maximum. Tak zjistíme plán s nejvyšší kvalitou.
Takových $p$ může být několik a ideálně je chceme najít všechny.
V první řadě je potřeba vhodně nadefinovat plán a účelovou funkci. 
Účelovou funkci podrobně popíšeme v %TODO odkaz na kapitolu nějak%
\textbf{odkaz}.
Nyní si rozmysleme, jak nadefinujeme plán.
Plán je alokace týmů záchranářu a záchranných vozidel na jednotlivé výjezdové stanice, kde týmy záchranářů jsou k dispozici v určitý čas v rámci jednoho dne.
Můžeme na to nahlížet jako na přiřazení časových intervalů, směn, na výjezdové stanice, kde by každý interval odpovídal jednomu týmu záchranářů a na přiřazení záchranných vozidel,
které budou na výjezdových stanicích pro záchranáře k dispozici.
Nechť $V$ je množina výjezdových stanic, $D \subseteq (\mathbb{R^+}, \mathbb{R^+})$ množina možných časových intervalů.
Například, $(8, 17) \in D$, značí směnu od 8 hodin do 17 hodin.
Dále nechť $Z$ množina týmu, které nám jsou k dispozici a $A$ množina záchranných vozidel, které nám jsou k dispozici. Definujme

\begin{align}
p_D \colon Z &\rightarrow D \\
p_V \colon Z &\rightarrow V \\
p_A \colon A &\rightarrow V 
\end{align}
.
\\
\\
Plán pohotovostní služby pak je trojice

\begin{align}
p = (p_D, p_V, p_A) \in P
\end{align}
.
\\
\\
Všimněme si, že s takovou definicí můžeme na optimalizační problém nahlížet jako na tři podoptimalizační úlohy.
První, optimálně namapovat týmy záchranářu na výjezdové stanice, druhý, optimálně každému týmu přiřadit směnu a třetí, optimálně alokovat záchranná vozidla na jednotlivé výjezdové stanice.
Může se stát, že některé týmy nebudeme chtít vůbec naalokovat, například z důvodu zvýšení efektivity plánu, pak je odebereme z $Z$. To stejné platí pro záchranná vozidla, odebereme z $A$.
\\
\\
Definujme navíc povolené plány $P_C \subseteq P$, kde $C$ jsou omezující podmínky. Pokud $p \in P$ splňuje omezující podmínky $C$, pak $p \in P_C$. 
Omezujícími podmínkamí může být celkový dostupný počet týmu záchranářu nebo záchranných vozidel. Případně maximální počet týmu nebo záchranných vozidel, které je možné naalokovat na výjezdovou stanici.

\section{Simulace}

Momentálně máme popsanou optimalizační úlohu, kterou řešíme. Ještě nám ale chybí jedna velmi podstatná část.
Konkrétní způsob, definice účelové funkce $q_I$, kterým zjistíme kvalitu libovolného plánu pohotovostní služby.
Jak již bylo zmíněno, ta by se měla co nejvíce odrážet z úspěšnosti odbavených incidentů a ceny za náklady.
Je velmi důležité, aby $q_I$ ohodnocovalo plány co nejdůvěryhodněji a aby hodnocení kvality plánu podle $q_I$ co nejvíce odpovídalo kvalitě plánu v reálném světě na reálných datech.
Pokud by $q_I$ neohodnocovalo plány důvěryhodně, pak by plán s nejvyšší kvalitou podle $q_I$ nemusel být vůbec výhodným a kvalitním pro reálné využití.
To by znamenalo, že nejkvalitnější nalezené plány pohotovostních služeb by nebyli nijak zajímavé a navrhnutá řešení v této práci by neměla žádnou hodnotu pro praktické využití.
Aby $q_I$ splňoval tyto požadavky, navrhuji pro daný plán simulovat, jak by obstál v reálné situaci.
Simulace je probraná do hloubky v kapitole \textbf{odkaz}. %TODO 
Pokud simulace bude důvěrně napodobovat průběh plánu jak by plán obstál v reálném světě, pak $q_I$ používající simulaci
bude odpovídat nejvěrohodněji reálné situaci a tedy bude ohodnocená kvalita plánu nejdůvěrnější.
Přístup použití simulace má ještě jednu podstatnou výhodu.
Různé pohotovostní služby mohou používat různé způsoby a pravidla, například pro výběr záchranné jednotky pro odbavení incidentu co právě nastal, nebo do jaké nemocnice incident odbavit.
Tato pravidla můžou být příliš složitá, aby je bylo možné výstižně zachytit jinými způsoby, jako například pouze matematickými nerovnostmi, jak je zvykem pro lineární programování.
V mnou implementované simulaci jsou použité pravidla vybrané na základě konzultace se společností, která se danou problematikou zabývá přes 25 let a sami podobná pravidla používají pro plánovaní sanitek
u několika jejich klientů ve Spojených státech.
Není však problém naimplementovat pravidla zcela jiná, komplikovanější nebo klidně i stochastická.
Použití simulace přináší příjemnou flexibilitu a zároveň lze díky ní nejlépe popsat jak konkrétně má plán pohotovostní služby v konkrétních situacích reagovat.
Síla a flexibilita kterou simulace přináší se bohužel musí někde kompenzovat.
Tím jsou výpočetní náročnost simulace a poměrně značné omezení použitelných technik obecně využívané pro řešení optimalizačních problémů.
\\
\\
Jedná se o deterministickou diskrétní simulaci, kde událost je nastání incidentu $I_i \in I$ v čase $T_i \in T$ a stav simulace $S$
jsou stavy záchranných vozidel $S_A$ a stavy týmů záchranářů $S_Z$.
Simulace si první setřídí sadu incidentů podle časů nastání $T$.
Následně se simulace pohybuje po těchto časech od nejdřívějšího až po poslední incident podle $T_i$.
V každém kroku simulace $i$, kterých je celkem $|T|$, si simulace aktualizuje stavy $S_A$ a $S_Z$.
V každém kroku deterministicky vybere $z_i \in Z$ a pro něj $a_i \in A$, který obslouží $I_i$. 
Po doběhnutí simulace jsou k dispozici statistiky, jako procento úspěšně odbavených incidentů.
Statistiky a cenu plánu pak může vhodně použít $q$ pro vypočítání celkové kvality plánu.

\clearpage

\begin{algorithmic}[1]  % [1] způsobí, že číslujeme kroky algoritmu
\Function{Simulation}{$I$}
	\State $I \gets \mbox{Setřídí incidenty podle času nastání}$
	\State $\text{SuccessRate} \gets 100\%$
	\State $S_A \gets \mbox{Inicializuje}$
	\State $S_Z \gets \mbox{Inicializuje}$
  \State $T$ \gets 0
  \For{$I_i \in I,~ i \in \{0, 1, \dots , |I|\}$}
    \State $T \gets \mbox{Čas nastání $I_i$}$
    \State $z \gets \mbox{GetBestTeam($I_i$)}$
    \If{\mbox{Neexistuje tým který by úspěšně odbavil $I_i$}}
      \State $\text{SuccessRate} \gets \mbox{Sniž}$
      \State \textbf{continue}
    \EndIf
    \State Naplánuj($z$, $I_i$)
    \State $S_A \gets \mbox{Update}$
    \State $S_Z \gets \mbox{Update}$
  \EndFor
  \State \Return SuccessRate
\EndFunction
\end{algorithmic}

\vspace*{25px}

Funkce GetBestTeam první nalezne množinu všech týmů záchranářů $Z'$, kteří jsou schopni $I_i$ obsloužit.
Tým záchranářu je schopen obsloužit $I_i$ pokud:

\begin{enumerate}
  \item Je alokován a má přiřazenou směnu. Pokud tým záchranářu není alokován na žádnou výjezdovou stanici a nemá přiřazenou směnu, tak samozřejmě není schopen obsloužit $I_i$.
  \item Tým je schopen dorazit na místo incidentu do požadované doby. Ať už přímo z výjezdové stanice, nebo při vrácení se po vyřízení incidentu zpět na výjezdovou stanici. 
    V prvním případě tým potřebuje mít na výjezdové stanici k dispozi volné záchranné vozidlo. V druhém případě už záchranné vozidlo k dispozici má.
  \item Týmu nekončí směna dřive, než je očekávaný konec celkové doby vyřízení incidentu.
\end{enumerate}

Následně vybere nejvhodnější tým záchranářu podle pravidel:

\begin{enumerate}
  \item Upřednostni tým, který je na výjezdové stanici před týmem, který ukončuje vyřízení jednoho z předchozích incidentů. 
  \item Upřednostni tým, který na místo incidentu dorazí dříve. 
  \item Upřednostni tým, který již obsloužil méně incidentů a je tedy méně vyčerpaný.
\end{enumerate}

\clearpage

Na nejvhodnější nalezený tým záchranářů $z$ naplánujeme $I_i$. Pro to je potřeba vypočítat očekávaný příjezd záchranné jednotky, dobu strávenou na místě incidentu, očekávaný příjezd
do nejbližší nemocnice, dobu strávenou v nemocnici a následně očekávaný příjezd zpět na výjezdovou stanici.
Během jízdy z nemocnice zpět na výjezdovou stanici může dojít k naplánování záchranné jednotky na nový incident, pokud bude podle pravidel vybrán jako nejvhodnější.
\\
\\
Pravidla jsou navrhnuta tak, aby práce obsluhování incidentů byla rozmístěna rovnoměrně přes všechny týmy, ale aby zároveň byli incidenty obslouženy nejrychleji jak je možné.
Třetí pravidlo pro výběr nejvhodnějšího týmu zaručuje rovnoměrnost práce a druhé co nejrychlejší obsloužení incidentu.
Pravidla také počítají s možným zpožděním a raději upřednostní tým, který je aktuálně k dispozici, než tým, který ještě dokončuje jiný incident, ale mohl by i na místě incidentu
být dříve, pokud by neměl zpoždění. Příkladem je první pravidlo pro výběr nejvhodnějšího týmu.

\section{Účelová funkce}

Od účelove funkce $q_I$ vyžadujeme aby maximalizovala počet odbavených incidentů a minimializovala celkovou cenu plánu pro množinu incidentů $I$.
\\
\\
Mějme povolený plán $p \in P'$. Nechť $s_{pI} = S_I(p)$ úspěšnost odbavení, to je počet odbavených incidentů v poměru počtu všech incidentů,
a $c_{pI} = C(p)$ poměr ceny $p$ ku maximální možné ceně $p$, kde $S_s$ funkce využívající simulaci $S$.
Všimněme si, že maximalizování počtu odbavených incidentů je konfliktní s minimalizováním celkové ceny plánu.
Nejen z tohoto důvodu je žádoucí si pořídit způsob, kterým budeme schopní určit, kterou podoptimalizaci má $q_I$ preferovat.
Zároveň je užitečné mít takovou možnost, protože nám bude dávat větší kontrolu nad řízením optimalizace.
Pro tento účel si pořídíme vlastní váhy $\alpha, \beta \in [0, 1]$.
\\
\\
Nyní je potřeba $s_{pI}, c_{pI}$ spolu s váhami $\alpha, \beta$ zkombinovat do jedné hodnoty, kterou budeme chtít maximalizovat.
Definujme účelovou funkci $q_I$:

$$
  q_I(p) = \alpha \cdot s_{pI} - \beta \cdot e_{pI}
$$
.
\\
\\
Jak vidíme, ve skutečnosti se jedná o víceúčelovou funkci.
Víceúčelová funkce $q_I$ nabývá vyšších hodnot při vyšší úspěšnosti odbavených incidentů a nižši cenně plánu.
Nižší pak v opačném případě, přesně jak jsme požadovali.
Navíc, díky váhám $\alpha, \beta$ můžeme snadno upřednostit jaké aspekty jsou pro nás při optimalizaci důležitější.
\\
\\
Je jasné, že $q_I$ nabývá globální maximum při 100\% odbavení incidentů a plánu s nulovou cenou.
Také je zřejmé, že takový plán nemůže existovat, minimálně kvůli požadavku na nulovou cenu, ale taky nemusí být pro konkrétní sadu incidentů 100\% odbavení možné.
Nesmíme zapomenout, že $s_{pI}$, klíčovou statistiku pro zjištění kvality plánu,
získáme prostřednictvím simulace $S_I$, funkci parametrizovanou $p \in P_C$ a zafixovanou množinou incidentů $I$.
I když se tedy na první pohled může zdát účelová funkce jednoduchá, není možné nalézt globalní maximum přímým výpočtem.
Jednoduše proto, že funkce $S_I$ nemá žádný matematický předpis.

\section{Klasifikace optimalizační úlohy}

Jedná se o diskrétní kombinatorickou optimalizaci s omezujícími podmínkami $C$, kde víceúčelová funkce $q_I$ pro výpočet kvality plánu používá úspěšnost
odbavení incidentů $s_pI$ a cenu $c_pI$ plánu, pronásobené váhami $\alpha, \beta \in [0, 1]$,
přičemž pro získání $s_pI$ pro $p \in P_C$ a $I$ je nutné spustit simulaci $S_I$.
Funkce $S_I$ nemá žádný matematický předpis, z toho důvodu $q_I$ není derivovatelná.
Nemůže tak splňovat podmínky optimalizace prvního (1.5) ani druhého řádu (1.6) %TODO cituj a odkaz

\begin{align}
  &\nabla q_I(p^*) = 0 \\
  &\nabla^2 q_I(p^*) \hspace{50pt} \text{je positivně semidefinitní}
\end{align}
.
\\
\\
Z toho plyne, že pro nalezení optima nelze použít žádné metody prvního ani druhého řádu. %TODO cituj
Na víceúčelovou funkci $q_I$ můžeme pouze nahlížet jako na černou skříňku %TODO neni neformalni?
, ze které jedině můžeme získávat vzorky v diskrétních bodech.
Zřejmě nemůžeme navzorkovat $q_I$ přes všechny $p \in P_C$ a vybrat z nich maximum, protože obecně $P_C$ je příliš velká.
Kokrétně, velikost $P_C$ se odvíjí od počtu výjezdových stanic $v = |V|$, počtu záchranných vozidel $a = |A|$, počtu záchranných týmů $z = |Z|$, počtu možných směn $d = |D'|$, 
maximálního počtu týmů na stanici $c_z$ a maximálního počtu sanitek na stanici $c_a$.

\begin{align}
  \sum_{i=0}^{z}{d^{v \cdot c_z \choose z - i}} \cdot \sum_{i = 0}^{a}{v \cdot c_a \choose a - i}
\end{align}
\\
\\
Toto (1.7) %odkaz
přesně odpovídá velikosti prostoru dovolených plánu $P_C$. Vybíráme ($z-i$)-tice přes počet stanic a dovolený počet týmů na stanici, a ještě každému týmu
přiřadíme směnu, kterých je $d$. Pro každé takové rozmístění týmů ještě potřebujeme vybrat rozmístění záchranných vozidel.
Způsob výběru je stejný, akorát nepočítáme přiřazení směny.

\clearpage

Odhadneme,

\begin{align*}
  \sum_{i=0}^{z}{d^{v \cdot c_z \choose z - i}} \cdot \sum_{i = 0}^{a}{v \cdot c_a \choose a - i}
  &< z \cdot d^{\left( \frac{v \cdot c_z \cdot 2^{v \cdot c_z}}{e} \right)} \cdot a \cdot {\frac{v \cdot c_a \cdot 2^{v \cdot c_a}}{e}}\\
  &< z \cdot d^{v \cdot c_z \cdot 2^{v \cdot c_z}} \cdot a \cdot {v \cdot c_a \cdot 2^{v \cdot c_a}}\\
  &\sim \mathcal{O}(z \cdot d^{v \cdot 2^v} \cdot av \cdot 2^v)\\
\end{align*}
.
\\
\\
Použitím odhadu kombinačního čísla prostředním, největším, kombinačním číslem přes sčítání velikosti disjunktních množin a následnými úpravami,
dostaneme, že $|P_C| \sim \mathcal{O}(z \cdot d^{v \cdot 2^v} \cdot av \cdot 2^v)$.
Na $c_z$ a $c_a$ nahlížíme jako na konstanty, protože v praxi se o konstanty jedná. Jedná se o řádově těsný odhad, takže jistě existuje $c_1$, aby $|P_C| \sim \Omega(z \cdot d^{v \cdot 2^v} \cdot av \cdot 2^v)$.
Takže 

\begin{align*}
  |P_C| \sim \Theta{(z \cdot d^{v \cdot 2^v} \cdot av \cdot 2^v)}
\end{align*}
.
\\
\\
Prostor plánu je exponenciálně velký vůči násobku počtu výjezdových stanic $v$ a počtu možných směn $d$.
\\
\\
Časová složitost běhu jedné simulace pro množinu incidentů $I$ je $\sim \Theta{(|I| \cdot z \cdot c_a})$.
Potřebujeme pro každý incident nalézt nejvhodnější tým a pro daný tým nejvhodnější záchranné vozidlo na výjezdové stanici, kde se tým nachází.
\\
\\
Časová složitost přeiterování přes všechny plány a spuštění simulace je

$$
  \Theta{(z \cdot d^{v \cdot 2^v} \cdot av \cdot 2^v \cdot |I| \cdot z \cdot c_a)}
$$
.
\\
\\
Zřejmě tedy nelze naivně zkusit spustit simulaci pro každý plán $p \in P_C$, držet si $p^*$ s maximální hodnotou účelové funkce a tak najít nejkvalitnější plán.
\\
\\
Dále, nelze ani v rozumném čase zjistit maximální kvalitu plánu, protože ani nelze v rozumném čase zjistit maximální možnou úspěšnost.
Uvažme množinu plánů $P_{max} \subseteq P_C$, obsahující pouze plány s maximální délkou směny $d_{max} \in D$ a uvažme sitauci kdy máme dostatek záchranných týmů i vozidel,
takže na každé výjezdové stanici jich máme maximální počet.
\\
\\
Nechť $p*_{max} \in P_{max}$, $S_{I}(p*_{max}) = s_{max}$.
Pokud $\forall p_{max} \in P_{max} \colon S_{pI}(p_{max}) \leq s_{max}$, pak jistě $\forall p \in P_C \colon S_{pI}(p) \leq s_{max}$.
Zřejmě pokud mezi plány s maximální délkou směny pro všechny týmy a maximálním počtem týmů a vozidel přes stanice nalezneme $s_{max}$,
pak se jedná i o maximální možnou úspěšnost přes všechny možné plány. S kratšími délkami směn si pomůžeme se snížením ceny, avšak v úspěšnosti si můžeme jedině uškodit.
Jenže $|P_{max}| \geq d^z$. Hodnota $d$ se v praxi pohybuje kolem nižších desítek a $z$ nižších stovek,
takže očividně i velikost $P_{max}$ je prakticky příliš velká na lineární průchod a tak nalezení maxima.
Zároveň pokud $s'_{max}$ maximem $P'_{max} \subseteq P_{max}$, nemůžeme nikdy prohlásit za maximum $P_{max}$, protože vždy může existovat $p_{max}* \in P_{max} \setminus P'_{max}$ s vyšší kvalitou.
Čili $P_{max}$ je nejmenší možná množina kterou musíme proiterovat pro nalezení plánu s nejvyšší úspěšností s jistotou.
Z toho plyne, že nelze získat ani maximální kvalitu plánu, takže kvality plánu můžeme porovnávat pouze mezi sebou, nikoliv jak blízko jsou nejlepší možné kvalitě.

\section{Metody řešení}

Z minulé kapitoly již víme, že nelze vyzkoušet všechny plány a nalézt tak nejkvalitnější, protože velikost $P_C$ je příliš velká.
Víceúčelová funkce $q$ není lineární a není ani derivovatelná, jelikož interně spouští $S_I$, simulaci plánu na množině $I$.
Nesplňuje tak předpoklady pro použití metod prvního ani druhého řádu.
Optimalizační úlohu nelze vyjádřit ve tvaru soustav lineárních rovností a nerovností, takže ani jakékoliv techniky ze světa linéárního programování nám nejsou k dispozici.
Jediné co máme k dispozici jsou hodnoty účelove funkce $q$ v bodech $p$.
Pokud nebudeme schopni nalézt rekurzivní vztah, který budeme schopni pomocí memoizace vyřešit v pseudo polynomiálním čase pomocí dynamického programování, tak nejsem schopni
s jistotou nalézt optimální řešení a budeme se muset uchýlit k heuristickým přístupům.
Řešení přes dynamické programování podrobně popisuji (\textbf{odkaz}).
V práci se především věnuji metaheuristickým prohledávacím metodám, %TODO pak tady více rozved
jak metodám prohledávajících prostor lokálně, jako tabu prohledávání až po populační metody, jako genetické algoritmy.


Omezme se na $P' \subset P_C$, která je rozumně velká. Například ne exponenciálně.
Nechť $p'_{max} \in P'$ s maximální kvalitou pro $I$.
Pak jistě může existovat $p_{max} \in P \setminus P' \colon S_{I}(p_{max}) > S_{I}(p'_{max})$.
\\
\\


