\chapter{Řešení optimalizační úlohy}\label{chap:reseniOptUloh}

V této kapitole vyzkoušíme různé metody, které můžeme pro nalezení optimálního plánu pohotovostní služby použít.

\section{Dynamické programování}\label{kap:dynamicProgram}

\textit{Dynamické programování} je technika řešení problému, která si průběžně ukládá řešení menších podúloh a pomocí rekurzivního vztahu menší podúlohy s větší,
definovaného \textit{Bellmanovou rovností}, řeší větší podúlohy efektivněji, až po vyřešení původní úlohy. 
Průběžnému ukládání výsledků podúloh se říká \textit{memoizace}.
Díky této memoizaci dynamické programování neprohledává prostor řešení duplicitně, a tak je často velmi efektivní metodou pro řešení optimalizačních úloh (\citet{dynamic}).
Triviálním příkladem využití dynamického programování je výpočet $n$-tého \textit{Fibbonaciho čísla}. (\citet{mares}, kap. 12).

Pro nás zajímavějším příkladem využití dynamického programování je řešení úlohy kombinatorické optimalizace \textit{Problému batohu}.

\begin{definice}[Problém batohu]
  Nechť $n$ počet předmětů, které chceme vložit do batohu s kapacitou $c$.
  Každý předmět $i$ má výdělek $p_i$ a váhu $w_i$. Problém batohu pak je,

  \begin{alignat*}{2}
    &\normalfont \text{maximalizuj} \hspace{30pt} &z = \sum_{i=1}^n p_i x_i \\
    \\
    &\normalfont \text{splňující} \hspace{30pt} &\sum_{i = 1}^{n} w_i x_i \leq c,
  \end{alignat*}
  \\
  kde $x_i = 1$, pokud předmět $i$ je v batohu, jinak $0$.
  \\
\end{definice}

Existuje $2^n$ možností, které předměty vložíme do batohu. Naivní řešení prohledání všech možností tak běží v čase $\mathcal{O} (2^n)$.
Avšak pomocí dynamického programování lze vyřešit problém batohu v \textit{pseudopolynomiálním} čase $\mathcal{O}(nc)$,
což pro velká $n$ a konstatní $c$ je až exponenciálním zlepšením.

Bellmanovy rovnice vyjadřující rekurzivní vztahy vypadají následovně,

\begin{definice}[Rekurzivní vztah pro problém batohu]\label{rov:KPrekurz}
  \begin{align*}
    m_{i, c'} &= m_{i - 1, c'} \text{ pokud } w_i > c', \\
    m_{i, c'} &= \max (m_{i - 1, c'}, m_{i - 1, c' - w_i} + p_i) \text{ pokud } w_i \leq c',
  \end{align*}
  \\
  pro $0 \leq c' \leq c$ aktuální uvažovaná kapacita batohu.
\end{definice}

Rekurzivní vztah \ref{rov:KPrekurz} nám pouze říká, že ze znalostí optimálního výběru předmětů podpbroblému $m_{i-1, c' - w_i}$ a podproblému $m_{i - 1, c'}$,
umíme v konstantím čase zjistit optimální výběr předmětů pro aktuální problém $c'$, tedy $m_{i, c'}$.
Buď předmět $i$ použijeme při výběru, a tak aktuální optimální výběr je roven $m_{i - 1, c' - w_i} + p_i$,
nebo předmět při výběru nepoužijeme, takže aktuální optimální výběr je optimální výběr podproblému, $m_{i - 1, c'}$. 

\begin{algorithm}[h]
  \begin{algorithmic}[1]
  \Function{KnapsackProblem}{$n$, $c$, $p_i$, $w_i$, $1 \leq i \leq n$}
    \State $m_{i, j}$ \gets 0, $0 \leq i \leq n$, $0 \leq j \leq c$
    \For{$1 \leq i \leq n$}
      \For{$1 \leq j \leq c$}
        \If{$w_i > j$}
          \State $m_{i, j}$ \gets $m_{i - 1, j}$
        \Else
          \State $m_{i, j}$ \gets $\max$ ($m_{i - 1, j}$, $m_{i - 1, j - w_i} + p_i$)
        \EndIf
      \EndFor
    \EndFor
    \State \Return $m_{n,c}$
  \EndFunction
  \end{algorithmic}
  \caption{Problém batohu}
  \label{KP}
\end{algorithm}

Algoritmus \ref{KP} vrací sumu hodnot optimálních předmětů přidaných do batohu.
Jaké konkrétní předměty přispěly do sumy lze snado zjistit zpětným následováním rekurzivního vztahu \ref{rov:KPrekurz}.

Rádi bychom našli nějaký podobný rekurzivní vztah v problému hledání optimálního plánu.
Nalezením rekurzivních vztahů by pak simulace $s$ nebyla černou skříňkou a byla by splněna nutná podmínka \ref{veta:simulaceJakoCernaSkrinka} pro šanci na polynomiální řešení.

\section{Prohledávání prostoru plánů tahy}

\begin{definice}[Seřazené incidenty]\label{df:INC}
  Nechť množina incidentů 
  \begin{equation*}
    I = \{ i_1, \dots , i_n \} \text{, kde } \forall j, k \in \{ 1, \dots n\} \colon T_I(i_j) \leq T_I(i_k),
  \end{equation*}
  čili incidenty jsou seřazené podle času nastání.
  Definujme množiny incidentů
  \begin{equation*}
    I_0, I_1, \dots, I_n \text{, kde } \forall k \in \{ 0, \dots, n \} \colon I_k = \{ i_1, \dots, i_k \}.
  \end{equation*}

  Incidenty $I_k$ jsou tak incidenty $I_{k-1}$ po odebrání incidentu $i_k$, který se odehrál jako poslední.
\end{definice}

\begin{definice}[Tah]\label{df:tah}
  Nadefinujme tah jako funkci $T \colon P_C \rightarrow P_C$.
  Pokud $p' = T(p)$, řekneme, že jsme plán $p'$ získali z $p$ tahem $T$.
\end{definice}

\begin{definice}[Inverzní tah]\label{df:tah}
  Nechť tah $T$. Inverzní tah $T^{-1}$ k tahu $T$ je tah, pro který platí

  \begin{align*}
    T(p) = p' \Leftrightarrow T^{-1}(p') = p.
  \end{align*}
\end{definice}

Inverzní tah obecně nemusí existovat. Ukažme si, jaké podmínky musí platit pro jeho existenci.

\begin{veta}[Podmínka existence inverzního tahu]\label{veta:inverzNutnost}
  Inverzní tah $T^{-1}$ k tahu $T$ existuje, pokud $\forall p_1, p_2 \in P_C \colon T(p_1) = T(p_2) \implies p_1 = p_2$.
  Čili tah $T$ je prostá funkce.

\end{veta}
\begin{dukaz}
  Inverzní tah $T^{-1}$ zkonstruujeme.
  Z předpokladu věty víme, že neexistuje plán $p'$ takový, že $T(p_1) = T(p_2) = p'$ pro různá $p_1, p_2 \in P_C$. 
  Proto můžeme inverzní tah definovat jako

  \begin{alignat*}{2}
    & T^{-1}(p') = p, \quad && \hspace{10pt} \text{takové, že $T(p) = p'$}.
  \end{alignat*}
\end{dukaz}

Tahy budeme používát pro převádění jednoho plánu na druhý nějakou posloupností tahů.

\begin{definice}[Posloupnost tahů]
  Posloupností tahů velikosti $n$ rozumíme posloupnost tahů $T_1, T_2, \dots, T_n$.
  Řekneme, že z plánu $p$ získáme plán $p'$ posloupností tahů $T_1, T_2, \dots, T_n$,
  pokud $(T_1 \circ T_2 \circ \dots \circ T_n)(p) = p'$, kde symbol $\circ$ značí binární operaci skládání funkcí,
  kde se první vyhodnotí levá funkce a pak pravá.
\end{definice}

Ukažme si příklady nějakých tahů.

\begin{definice}[Kanonické tahy]
  Kanonickými tahy rozumíme tahy
  \begin{enumerate}
    \item
      Alokace záchranného týmu na výjezdovou stanici.

    \item
      Alokace záchranného vozidla na výjezdovou stanici.

    \item
      Prodloužení doby trvání směny již naalokovaného záchranného týmu. 

    \item
      Identita.
  \end{enumerate}

  Formálně,
  \begin{enumerate}
    \item
      kanonický tah alokace týmu $z'$ na výjezdovou stanici je funkce $M_{z'} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &=
          \begin{cases}
            v \neq v_{\emptyset} & \text{pro tým $z' \in Z \colon p_Z(z') = v_{\emptyset}, v \in V$}, \\
            p_Z(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_D'(z) &=
          \begin{cases}
            (d_1, d_2) \in D \colon d_2 - d_1 > 0 & \text{pro $z'$}, \\
            p_D(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'}(p) = p'$.

    \item
      Kanonický tah alokace záchranného vozidla $a'$ na výjezdovou stanici je funkce $M_{a'} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in Z,
        \\
        p_D'(z) &= p_D(z), \forall z \in Z,
        \\
        p_A'(a) &=
        \begin{cases}
          p_Z'(z) & \text{pro záchranné vozidlo $a' \in A \colon p_A(a') = v_{\emptyset}, v \in V$.}, \\
          p_A(a) & \text{pro $\forall a \in A \setminus \{ a' \}$},
        \end{cases}
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'a'}(p) = p'$.

    \item
      Kanonický tah prodloužení směny týmu $z'$ je funkce $M_{z'd} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in Z \\
        p_D'(z) &=
          \begin{cases}
            (d'_1, d'_2) \in D \colon d'_2 > d_2 \land d'_1 = d_1  & \text{pro $z'$, kde $(d_1, d_2) = p_{D}(z)$} \\
            p_D(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'd}(p) = p'$.

    \item
      Kanonický tah identita je funkce $M_{id}: p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in z \\
        p_D'(z) &= p_D(z), \forall z \in Z \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{id}(p) = p'$.
  \end{enumerate}

\end{definice}

Vidíme, že popsat tah formálně je komplikované a pro naše účely zbytečné.
Proto dále budeme tahy definovat slovně, ale zároveň tak, aby nedocházelo k nejasnostem.

Můžou existovat plány $p \in P_C$, na kterých nějaký tah nelze provést, čili $T(p)$ je nedefinované.
Například, pokud bychom plánu chtěli alokovat tým, ale už nejsou žádné k dispozici, nebo už není volná žádná výjezdová stanice podle omezení $C$.

\begin{definice}[Tah lze provést na plánu]
  Řekneme, že tah $T$ lze provést na plánu $p \in P_C$, pokud $T(p)$ je definováno.
\end{definice}

\begin{veta}[Inverzní kanonické tahy]\label{veta:invKanTahy}
  Nechť kanonické tahy alokování týmu $z$ tah $T_1$, alokování vozidla $a$ tah $T_2$ a prodloužení směny $z$ o $d$ tah $T_3$.
  Inverzní tahy k nim existují a jsou:

  \begin{enumerate}
    \item
      dealokování týmu $z$ tah $T_1^{-1}$,

    \item
      dealokování vozidla $a$ tah $T_2^{-1}$,

    \item
      zkrácení směny $z$ o $d$ tah $T_3^{-1}$,

    \item
      identita.
  \end{enumerate}
\end{veta}
\begin{dukaz}
  První ukažme, že kanonické tahy splňují nutné podmínky pro existenci inverzního tahu \ref{veta:inverzNutnost}.
  Pro identitu platí triviálně.

  Pro $T_1, T_2, T_3$ platí, že pokud $T_i(p_1) = T_i(p_2)$, tak se muselo jednat o stejné plány už před provedením tahu a o různé, pokud $T_i(p_1) \neq T_i(p_2)$.
  Pro $T_1$ je dealokování týmu přesná konstrukce inverzního tahu z důkazu věty \ref{veta:inverzNutnost}.
  Stejně tak pro $T_2$ a $T_3$.

  Inverzní tahy k $T_1, T_2$ a $T_3$ existují a jedná se právě o $T_1^{-1}, T_2^{-1}, T_3^{-1}$.
  Inverzní tah k identitě je identita.
\end{dukaz}

\begin{veta}\label{veta:kazdyInvSnizujeCenu}
  Každý inverzní kanonický tah kromě identity snižuje cenu.
\end{veta}
\begin{dukaz}
  Plyne přímo z konstrukce inverzních kanonických tahů \ref{veta:invKanTahy} a z definice ceny plánu \ref{df:cenaPlanu}.
\end{dukaz}

\begin{veta}\label{veta:kazdeSnizeniCenyJeInv}
  Každé snížení ceny plánu lze docílit nějakou posloupností inverzních kanonických tahů.
\end{veta}
\begin{dukaz}
  Snížení ceny plánu z definice ceny plánu \ref{df:cenaPlanu} lze docílit jedině zkrácením směny nějakému týmu, dealokací nějakého týmu nebo dealokací nějakého vozidla.
  To jsou přesně inverzní kanonické tahy.
\end{dukaz}

\begin{definice}[Dosažitelnost tahy]
  Nechť množina tahů $T$.
  Plán $p_2$ je dosažitelný tahy $T$ z plánu $p_1$, pokud existuje posloupnost tahů $T_1 \in T, \dots, T_n \in T$ taková, že $(T_1 \circ \dots \circ T_n)(p_1) = p_2$.
\end{definice}

Pomocí tahů můžeme $P_C$ \textit{prohledávat}.
Pokud optimální plán $p^* \in P_C$ je nějakými tahy $T_i$ dosažitelný z $p \in P_C$, pak ho můžeme prohledáváním, které začíná v $p$ nalézt.
Pomocí tahů můžeme $P_C$ prohledávat sofistikovaněji, než je jenom všechny procházet, jak jsme dělali v naivním řešení \ref{df:naivniRes}.
Některé plány totiž ani nemá smysl prohledávat, jako například plány, které naalokují záchranáře tak nešikovně, že neodbavují úspěšně žádný incident.
Taková naalokování jenom přispívají do ceny plánu, ale nijak do počtu úspěšně odbavených incidentů.
Dále budeme zkoumat, jaké plány má smysl prohledávat.

\begin{definice}[Plán optimální v ceně]
  Nechť množina incidentů $I$ a plán $p \in P_C \colon s_c(p, I) = r$.
  Řekneme, že $p$ je optimální v ceně právě tehdy, když
  pro plán $p'$ vzniklý z $p$ provedením libovolného inverzního kanonického tahu kromě identity platí: 
  \begin{equation*}
    s_c(p', I) < r.
  \end{equation*}
\end{definice}

\begin{definice}[Tah minimální prodloužení směny týmu]
Tahem \textit{minimální prodloužení směny týmu} na plánu $p \in P_C$, rozumíme tah $T$, prodloužení směny týmu $z$ a případně alokace vozidla tak, že
  \begin{enumerate}
    \item
      $s_c(T(p), I) = s_c(p, I) + 1$,
    \item
      $T(p)$ je optimální v ceně,
    \item
      tým $z$ odbavuje $i \in I$ takový, že před provedením tahu nebyl odbavován.
  \end{enumerate}
\end{definice}

\begin{definice}[Tah minimální alokace týmu]
Tahem \textit{minimální alokace týmu} na plánu $p \in P_C$, rozumíme tah $T$, alokace týmu $z$ a případně alokace vozidla tak, že
  \begin{enumerate}
    \item
      $s_c(T(p), I) = s_c(p, I) + 1$,

    \item
      $T(p)$ je optimální v ceně,

    \item
      začátek směny $z$ je nejpozdější možný,

    \item
      tým $z$ odbavuje $i \in I$ takový, že před provedením tahu nebyl odbavován.
  \end{enumerate}
\end{definice}

\begin{definice}[Optimální tahy]\label{df:optimalniTahy}
  Nechť plán $p \in P_C$ a množina incidentů $I$.
  Optimálními tahy $T^*$ plánu $p$ rozumíme množinu tahů:
  \begin{enumerate}
  \item
    tah minimální alokace týmu,
  \item
    tah minimální prodloužení směny týmu,
  \item
    tah identita,
  \end{enumerate}
  které lze na plánu $p$ provést.
\end{definice}

\begin{veta}[O optimálních tazích]\label{veta:optimalniTahy}
  Nechť množiny incidentů $I_0, \dots, I_n$ podle definice \ref{df:INC}.
  Nechť plán optimální v ceně $p_k \in P_C \colon s_c(p_k, I_k) = r$.
  Pak existuje plán optimální v ceně
  \begin{equation*}
    p_{k-1} \in P_C \colon s_c(p_{k-1}, I_{k-1}) = r \lor s_c(p_{k-1}, I_{k-1}) = r - 1
  \end{equation*}
  a optimální tah $T$ takový, že
  \begin{equation*}
    T(p_{k-1}) = p_k,
  \end{equation*}
\end{veta}
\begin{dukaz}
  Nechť $i_1, \dots, i_k$ incidenty $I_k$ a $i'_1, \dots, i'_r$ incidenty, které odbaví $p_k$.
  Rozlišme dvě situace, které mohou nastat:
  \begin{enumerate}
    \item
      $i'_r \neq i_k$,

    \item
      $i'_r = i_k$.
  \end{enumerate}
  Ukažme, že v prvním případě je hledaný $p_{k-1}$ právě $p_k$ a tah $T$ identita.
  Platí $s_c(p_k, I_{k-1}) = r$, protože $p_k$ neodbaví poslední incident $i_k \not \in I_{k-1}$ a simulace incidenty prochází postupně \ref{simulaceAlgo},
  takže výpočet simulace na plánu $p_{k}$ a na množinách $I_k$ i $I_{k-1}$ je do $i_{k-1}$ incidentu totožný.
  Zároveň $p_k$ je optimální v ceně. Pro spor předpokládejme, že není, takže existuje inverzní kanonický tah $T^{-1}$ různý od identity takový,
  že
  \begin{equation*}
    s_c(T^{-1}(p_k), I_{k-1}) = s_c(p_k, I_{k-1}) \land u(T^{-1}(p_k)) < u(p_k).
  \end{equation*}
  To je ale spor s optimalitou v ceně $p_k$, protože $s_c(p_k, I_{k-1}) = s_c(p_k, I_k)$ a $T^{-1}(p_k)$ může odbavit nanejvýš $r$ incidentů na $I_k$ -- $T$ je buď dealokace nebo zkrácení směny,
  a tím se více incidentů neodbaví.
  Platilo by tak
  \begin{equation*}
    s_c(T^{-1}(p_k), I_{k}) = s_c(p_k, I_{k}) \land u(T^{-1}(p_k)) < u(p_k).
  \end{equation*}

  V druhém případě, je poslední incident $i_k = i'_r$ plánem $p_k$ odbaven.
  Z toho důvodu $p_k$ na množině inidentů $I_{k-1}$ odbavuje incidenty $i'_1, \dots, i'_{r-1}$, o jeden méně -- opět, simulace incidenty prochází postupně \ref{simulaceAlgo}.
  Platí tak, že $s_c(p_k, I_{k-1}) = r - 1$. Plán $p_k$ však nemusí být optimální v ceně.
  Z věty \ref{veta:kazdeSnizeniCenyJeInv} víme, že snížení ceny lze docílit nějakou posloupností inverzních kanonických tahů.
  Chceme nalézt vhodnou posloupnost takovou, že díky ní zkounstruujeme optimální tah.

  Uvažme tým záchranářů $z$, který odbavoval incident $i_k$.
  Pro tým $z$ pak pro spuštění simulace na plánu $p_k$ na množině incidentů $I_{k-1}$ platí:

  \begin{enumerate}
    \item
      Tým $z$ odbavuje jenom $i_k$, pak je v plánu $p_k$ naalokován zbytečně. O odbavení všech ostatních $r-1$ incidentů se postarájí ostatní týmy.

    \item
      Tým $z$ odbavuje i jiné incidenty $I_z$, ale jelikož
      \begin{equation*}
        \forall i_z \in I_z \colon T_I(i_z) < T_I(i_k),
      \end{equation*}
      tak $z$ odbavuje $i_k$ až po odbavení všech incidentů $I_z$.
      Aby $i_k$ úspěšně odbavil, může mít delší směnu, než by měl, pro odbavení $I_z$.
  \end{enumerate}

  V druhém případě se směna obecně nemusí vždy zkracovat a pokud ano, je nutné ji zkrátit tak, aby už nešla zkrátit více,
  ale zároveň musí být stále odbavovány všechny incidenty $I_z$.
  Takovému zkrácení budeme říkat \textit{maximální zkrácení}.
  V obou případech ještě může být zbytečně naalokováno vozidlo, které $z$ používal pro odbavení $i_k$.

  Z pozorování plyne, že vždy existuje dvojice inverzních kanonických tahů $T_1^{-1}$ a $T_1^{-1}$, kde pro jejich složení $T^{-1} = T_1^{-1} \circ T_1^{-1}$,
  platí, že $T^{-1}(p_k)$ je optimální v ceně a $s_c(T^{-1}(p_k), I_{k-1}) = r - 1$.
  Těmi jsou buď:
  \begin{enumerate}
  \item
    dealokace týmu a dealokace vozidla, 
  \item
    maximální zkrácení směny týmu a dealokace vozidla,
  \item
    dealokace týmu a identita,
  \item
    maximální zkrácení směny týmu a identita,
  \item
    identita a identita.
  \end{enumerate}
  Ukázali jsme existenci $T^{-1}$ v obou případech. Z definice inverzního kanonického tahu:
  \begin{equation*}
    T = T_1 \circ T_2 \colon p_k = T(p_{k-1}), 
  \end{equation*}
  pro korespondující kanonické tahy $T_1$ a $T_2$ takové, že jsou inverzními tahy k $T_1^{-1}$ a $T_1^{-1}$.
  Možnými tahy $T$ tak jsou:
  \begin{enumerate}
  \item
    alokace týmu a alokace vozidla, 
  \item
    minimální prodloužení týmu a alokace vozidla,
  \item
    alokace týmu a identita,
  \item
    minimální prodloužení směny týmu a identita,
  \item
    identita a identita.
  \end{enumerate}

  Chtěli bychom minimální alokaci týmu. Sestrojme plán $p'_{k-1}$ tak, že
  provedeme tah posun začátku směny a případně zkrácení směny tak, aby $z$ stále odbavoval $I_z$.
  Plán po takovém tahu $p'_{k-1}$ stále odbavuje $i'_1, \dots , i'_{r-1}$ a zaručili jsme, že 
  alokace týmu je vždy minimální alokace týmu, jinak by $p_k$ nebyl optimální v ceně.
  Nalezli jsme plán $p'_{k-1}$ a optimální tah $T$ takový, že $T(p'_{k-1})$.
\end{dukaz}

\begin{veta}[O dosažitelnosti optimálního plánu optimálními tahy]\label{veta:dosazitelnostOptimalnimiTahy}
  Optimální plán $p^* \in P_C$ na množině incidentů $I$ při účelové funkci $p^{\text{Lex}}$ je z $p_0$ dosažitelný nějakou posloupností optimálních tahů $T_1 \circ \dots T_{|I|-1}$.
\end{veta}
\begin{dukaz}
  Nechť $n = |I|$.
  Plán $p^*$ je optimální a odbavuje $r = s_c(p^*, I)$ incidentů.
  Existují pro něj podle věty \ref{veta:optimalniTahy} optimální tah $T_{n-1}$ a plán $p_{n-1}$ takové, že
  \begin{equation*}
    p_n = T_{n-1}(p_{n-1})
  \end{equation*}
  a $p_{n-1}$ odbavuje stejně nebo o jeden méně incidentů na $I_{n-1}$ než $r$.
  Opět z věty \ref{veta:optimalniTahy} pro něj existují $p_{n-2}, T_{n-2} \colon p_{n-1} = T_{n-2}(p_{n-2})$.

  Takovou konstrukcí sestrojíme $p_{k}, T_{k}, \forall k \in \{ 0, \dots, n-1 \}$. 
  Plán $p_0$ je z věty \ref{veta:optimalniTahy} plán na prázdné množině odbavující buď jeden nebo nula incidentů, optimální v ceně.
  Pro prázdnou množinu incidentů jakýkoliv jiný plán než prázdný plán $p_0$ není optimální v ceně.
  Tudiž plán $p_0$ je prázdný plán.
  Tahy $T_k$ jsou optimální tahy, takže se jedná o hledanou posloupnost takovou, že
  \begin{equation*}
    p^* = (T_0 \circ T_1 \circ \dots \circ T_{n-1})(p_0).
  \end{equation*}
\end{dukaz}

Věta \ref{veta:dosazitelnostOptimalnimiTahy} nám dává návod, jak plány $P_C$ z $p_0$ prohledávat optimálními tahy $T_1 \in T^*_1, \dots , T_{|I| - 1} \in T^*_{|I|-1}$,
abychom při prohledání všech dosažitelných plánu libovolnou posloupností optimálních tahů nalezli všechny optimální plány při účelové funkci $q^{\text{Lex}}$ na libovolné možině incidentů.

\begin{algorithm}[h]
  \begin{algorithmic}[1]
  \Function{OptimalMovesSearch}{$p$, $I_k$, $h$}
    \If{$k = h$}
      \State \Return $\{ p \}$
    \EndIf
    \State $T^*_k$ \gets optimální tahy \ref{df:optimalniTahy}
    \State $P^*$ \gets $\emptyset$
    \For{$T^* \in T^*_k$}
      \State $P'^*$ \gets \text{OptimalMovesSearch($T^*(p)$, $I_{k+1}$, $h$)}
      \State $p^*$ \gets libovolný z $P^*$
      \State $p'^*$ \gets libovolný z $P'^*$
      \If{$P^* = \emptyset$}
        \State $P^*$ \gets $P'^*$ 
      \ElsIf{$q^{\text{Lex}}(p^*) = q^{\text{Lex}}(p'^*)$}
        \State $P^*$ sjednoť s $P'^*$
      \ElsIf{$q^{\text{Lex}}(p^*) < q^{\text{Lex}}(p'^*)$}
        \State $P^*$ nahraď $P'^*$
      \EndIf
    \EndFor
    \State \Return $P^*$
  \EndFunction
  \end{algorithmic}
  \caption{Rekurzivní prohledávání prostoru plánů optimálními tahy}
  \label{alg:rekProhPlanu}
\end{algorithm}

Pro zjištění všech optimálních plánu $P^*$ na množině incidentů $I$ algoritmus \ref{alg:rekProhPlanu} zavoláme: $P^* = $ OptimalMovesSearch($p_0$, $I_1$, $|I|$).

\begin{veta}[Korektnost a úplnost algoritmu \ref{alg:rekProhPlanu}]\label{}
  Algoritmus rekurzivního prohledávání prostoru plánů optimálními tahy \ref{alg:rekProhPlanu} nalezne všechny optimální plány $P^* \in P_C$ při účelové funkci $q^{\text{Lex}}$.
\end{veta}
\begin{dukaz}
  Z věty \ref{veta:dosazitelnostOptimalnimiTahy} víme, že $p^*$ je dosažitelný nějakou posloupností optimálních tahů. 
  V algoritmu v kroku 5 množina $T^*_k$ obsahuje všechny optimální tahy, které lze provést na plánu $p$ na množině $I_k$.
  V kroku 8 se rekurzivně zavoláme na každý $T^*(p), T^* \in T^*_k$.
  Algoritmus tudiž prohledá každou posloupnost optimálních tahů, takže určitě i všechny takové, kterými se získá libovolný optimální plán $p \in P^*$ \ref{veta:dosazitelnostOptimalnimiTahy}.
  Algoritmus je úplný.

  V krocích 11--17 z plánů, které se vrátí rekurzí vybíráme pouze ty optimální vůči $q^{\text{Lex}}$.
  Vybíráme tak ze všech plánů, které jsou dosažitelné nějakou posloupností optimálních tahů ty optimální.
  Algoritmus je korektní.
\end{dukaz}

\begin{definice}[Strom optimálních tahů]
  Strom optimálních tahů rozumíme strom rekurze algoritmu prohledávání prostoru plánů optimálními tahy \ref{alg:rekProhPlanu}.
\end{definice}

\begin{veta}[Odhad počtu optimálních tahů pro plán optimální v ceně $k$-pokrývající služby]\label{veta:pocetOptTahu}
  Nechť pohotovostní služba zaručuje $k$-pokrytí a
  nechť plán optimální v ceně $p \in P_C$ a nechť optimální tahy $T$, které lze provést na plánu $p$ na množině $I$.
  Pak
  \begin{equation*}
    1 \leq |T| \leq 2 \cdot Z_n + 1.
  \end{equation*}
\end{veta}
\begin{dukaz}
  Optimální tahy jsou minimální alokace týmu, minimální prodloužení směny týmu a identita.
  Počet minimálních alokací je nanejvýš
  \begin{alignat*}{2}
    2 \cdot Z_1, \quad && Z_1 \text{ je počet nenaalokovaných vozidel.}
  \end{alignat*}
  Násobíme dvěma pro případnou alokaci záchranného vozidla.
  Předpokládejme, že existuje optimální tah minimální alokace $T$, kde alokujeme tým $z$, který odbavuje incident $i \in I$.
  Směnu naalokovanému týmu $d \in D$ přiřazujeme tak, aby směna $z$ plánu $T(p)$ byla co nejkratší a zároveň aby začínala co nejpozději.
  Taková směna je jenom jedna.

  Stačí uvažovat pouze alokace, které budou odpovídat alokování na $V_k$.

  Počet minimálních prodloužení směny je nanejvýš
  \begin{alignat*}{2}
    2 \cdot Z_2, \quad && Z_2 \text{ je počet naalokovaných vozidel.}
  \end{alignat*}
  Opět násobíme dvěma pro případnou alokaci záchranného vozidla.
  Předpokládejme, že existuje optimální tah minimální prodloužení $T$, kde prodlužujeme tým $z$, který nově odbavuje incident $i \in I$.
  Směnu naalokovanému týmu $d \in D$ přiřazujeme tak, aby směna týmu $z$ plánu $T(p)$ byla co nejkratší.
  Taková směna je opět jenom jedna.

  Jelikož $Z_1 + Z_2 = Z_n$ a tah identita lze provést vždy a je jenom jedna, tak dohromady dostáváme:
  \begin{equation*}
    1 \leq |T| \leq 2 \cdot Z_n + 1.
  \end{equation*}
\end{dukaz}

\begin{veta}[Velikost stromu optimálních tahů]
\end{veta}
\begin{dukaz}
  Větvení stromu je dáno počtem optimálních tahů.
  Z věty \ref{veta:pocetOptTahu} jich je nanejvýš $2 \cdot Z_n + 1$.
  Hloubka stromu je $|I|$. 
  Počet vrcholů stromu činí
  \begin{equation*}
    \sum_{i=0}^{|I|} (2 \cdot Z_n + 1)^{i} = \frac{(2 \cdot Z_n + 1)^{|I| + 1}}{2 \cdot Z_n} \in \Theta \left (Z_n^{|I| + 1} \right ).
  \end{equation*}
\end{dukaz}

