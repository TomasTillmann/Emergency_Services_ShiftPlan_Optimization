\chapter{Řešení optimalizační úlohy}\label{chap:reseniOptUloh}

V této kapitole vyzkoušíme různé metody, které můžeme pro nalezení optimálního plánu pohotovostní služby použít.

\section{Dynamické programování}\label{kap:dynamicProgram}

\textit{Dynamické programování} je technika řešení problému, která si průběžně ukládá řešení menších podúloh a pomocí rekurzivního vztahu menší podúlohy s větší,
definovaného \textit{Bellmanovou rovností}, řeší větší podúlohy efektivněji, až po vyřešení původní úlohy. 
Průběžnému ukládání výsledků podúloh se říká \textit{memoizace}.
Díky této memoizaci dynamické programování neprohledává prostor řešení duplicitně, a tak je často velmi efektivní metodou pro řešení optimalizačních úloh (\citet{dynamic}).
Triviálním příkladem využití dynamického programování je výpočet $n$-tého \textit{Fibbonaciho čísla}. (\citet{mares}, kap. 12).

Pro nás zajímavějším příkladem využití dynamického programování je řešení úlohy kombinatorické optimalizace \textit{Problému batohu}.

\begin{definice}[Problém batohu]
  Nechť $n$ počet předmětů, které chceme vložit do batohu s kapacitou $c$.
  Každý předmět $i$ má výdělek $p_i$ a váhu $w_i$. Problém batohu pak je,

  \begin{alignat*}{2}
    &\normalfont \text{maximalizuj} \hspace{30pt} &z = \sum_{i=1}^n p_i x_i \\
    \\
    &\normalfont \text{splňující} \hspace{30pt} &\sum_{i = 1}^{n} w_i x_i \leq c,
  \end{alignat*}
  \\
  kde $x_i = 1$, pokud předmět $i$ je v batohu, jinak $0$.
  \\
\end{definice}

Existuje $2^n$ možností, které předměty vložíme do batohu. Naivní řešení prohledání všech možností tak běží v čase $\mathcal{O} (2^n)$.
Avšak pomocí dynamického programování lze vyřešit problém batohu v \textit{pseudopolynomiálním} čase $\mathcal{O}(nc)$,
což pro velká $n$ a konstatní $c$ je až exponenciálním zlepšením.

Bellmanovy rovnice vyjadřující rekurzivní vztahy vypadají následovně,

\begin{definice}[Rekurzivní vztah pro problém batohu]\label{rov:KPrekurz}
  \begin{align*}
    m_{i, c'} &= m_{i - 1, c'} \text{ pokud } w_i > c', \\
    m_{i, c'} &= \max (m_{i - 1, c'}, m_{i - 1, c' - w_i} + p_i) \text{ pokud } w_i \leq c',
  \end{align*}
  \\
  pro $0 \leq c' \leq c$ aktuální uvažovaná kapacita batohu.
\end{definice}

Rekurzivní vztah \ref{rov:KPrekurz} nám pouze říká, že ze znalostí optimálního výběru předmětů podpbroblému $m_{i-1, c' - w_i}$ a podproblému $m_{i - 1, c'}$,
umíme v konstantím čase zjistit optimální výběr předmětů pro aktuální problém $c'$, tedy $m_{i, c'}$.
Buď předmět $i$ použijeme při výběru, a tak aktuální optimální výběr je roven $m_{i - 1, c' - w_i} + p_i$,
nebo předmět při výběru nepoužijeme, takže aktuální optimální výběr je optimální výběr podproblému, $m_{i - 1, c'}$. 

\begin{algorithm}[h]
  \begin{algorithmic}[1]
  \Function{KnapsackProblem}{$n$, $c$, $p_i$, $w_i$, $1 \leq i \leq n$}
    \State $m_{i, j}$ \gets 0, $0 \leq i \leq n$, $0 \leq j \leq c$
    \For{$1 \leq i \leq n$}
      \For{$1 \leq j \leq c$}
        \If{$w_i > j$}
          \State $m_{i, j}$ \gets $m_{i - 1, j}$
        \Else
          \State $m_{i, j}$ \gets $\max$ ($m_{i - 1, j}$, $m_{i - 1, j - w_i} + p_i$)
        \EndIf
      \EndFor
    \EndFor
    \State \Return $m_{n,c}$
  \EndFunction
  \end{algorithmic}
  \caption{Problém batohu}
  \label{KP}
\end{algorithm}

Algoritmus \ref{KP} vrací sumu hodnot optimálních předmětů přidaných do batohu.
Jaké konkrétní předměty přispěly do sumy lze snado zjistit zpětným následováním rekurzivního vztahu \ref{rov:KPrekurz}.

Rádi bychom našli nějaký podobný rekurzivní vztah v problému hledání optimálního plánu.
Nalezením rekurzivních vztahů by pak simulace $s$ nebyla černou skříňkou a byla by splněna nutná podmínka \ref{veta:simulaceJakoCernaSkrinka} pro šanci na polynomiální řešení.

\section{Prohledávání prostoru plánů tahy}

\begin{definice}[Seřazené incidenty]\label{df:INC}
  Nechť množina incidentů 
  \begin{equation*}
    I = \{ i_1, \dots , i_n \} \text{, kde } \forall j, k \in \{ 1, \dots n\} \colon T_I(i_j) \leq T_I(i_k),
  \end{equation*}
  čili incidenty jsou seřazené podle času nastání.
  Definujme množiny incidentů
  \begin{equation*}
    I_0, I_1, \dots, I_n \text{, kde } \forall k \in \{ 0, \dots, n \} \colon I_k = \{ i_1, \dots, i_k \}.
  \end{equation*}

  Incidenty $I_k$ jsou tak incidenty $I_{k-1}$ po odebrání incidentu $i_k$, který se odehrál jako poslední.
\end{definice}

\begin{definice}[Množiny optimálních plánů]
  Nechť množiny optimálních plánů
  \begin{alignat}{2}
    & P^*_0, P^*_1, \dots, P^*_{n} \subset P_C \quad && \hspace{15pt} \text{optimální plány na množinách incidentů $I_0, I_1, \dots, I_n$.}
  \end{alignat}
  Optimální plány $P_0$ pro prázdnou množinu incidentů obsahují prázdný plán $p_0$, neobsahující alokace žádných týmů ani vozidel.
\end{definice}

Nadále budeme zkoumat otázku, zda jsme schopni ze znalosti $p^*_{k-1} \in P^*_{k-1}$ nalézt optimální plán $p^*_k \in P^*_k$ na množině incidentů $I_k$, pro nějaká $k \in \{ 1, \dots, n \}$.
V první řadě si potřebujeme nadefinovat jak obecně z nějakého plánu $p_1$ získat plán $p_2$. 
\begin{definice}[Tah]\label{df:tah}
  Nadefinujme tah jako funkci $T \colon P_C \rightarrow P_C$.
  Pokud $p' = T(p)$, řekneme, že jsme plán $p'$ získali z $p$ tahem $T$.
\end{definice}

\begin{definice}[Inverzní tah]\label{df:tah}
  Nechť tah $T$. Inverzní tah $T^{-1}$ k tahu $T$ je tah, pro který platí

  \begin{align*}
    T(p) = p' \Leftrightarrow T^{-1}(p') = p.
  \end{align*}
\end{definice}

Inverzní tah obecně nemusí existovat. Ukažme si, jaké podmínky musí platit pro jeho existenci.

\begin{veta}[Podmínka existence inverzního tahu]\label{veta:inverzNutnost}
  Inverzní tah $T^{-1}$ k tahu $T$ existuje, pokud $\forall p_1, p_2 \in P_C \colon T(p_1) = T(p_2) \implies p_1 = p_2$.
  Čili tah $T$ je prostá funkce.

\end{veta}
\begin{dukaz}
  Inverzní tah $T^{-1}$ zkonstruujeme.
  Z předpokladu věty víme, že neexistuje plán $p'$ takový, že $T(p_1) = T(p_2) = p'$ pro různá $p_1, p_2 \in P_C$. 
  Proto můžeme inverzní tah definovat jako

  \begin{alignat*}{2}
    & T^{-1}(p') = p, \quad && \hspace{10pt} \text{takové, že $T(p) = p'$}.
  \end{alignat*}
\end{dukaz}

Tahy budeme používát pro převádění jednoho plánu na druhý nějakou posloupností tahů.

\begin{definice}[Posloupnost tahů]
  Posloupností tahů velikosti $n$ rozumíme posloupnost tahů $T_1, T_2, \dots, T_n$.
  Řekneme, že z plánu $p$ získáme plán $p'$ posloupností tahů $T_1, T_2, \dots, T_n$,
  pokud $(T_1 \circ T_2 \circ \dots \circ T_n)(p) = p'$, kde symbol $\circ$ značí binární operaci skládání funkcí,
  kde se první vyhodnotí levá funkce a pak pravá.
\end{definice}

Ukažme si příklady nějakých tahů.

\begin{definice}[Kanonické tahy]
  Kanonickými tahy rozumíme tahy
  \begin{enumerate}
    \item
      Alokace záchranného týmu na výjezdovou stanici.

    \item
      Alokace záchranného vozidla na výjezdovou stanici.

    \item
      Prodloužení doby trvání směny již naalokovaného záchranného týmu. 

    \item
      Identita.
  \end{enumerate}

  Formálně,
  \begin{enumerate}
    \item
      kanonický tah alokace týmu $z'$ na výjezdovou stanici je funkce $M_{z'} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &=
          \begin{cases}
            v \neq v_{\emptyset} & \text{pro tým $z' \in Z \colon p_Z(z') = v_{\emptyset}, v \in V$}, \\
            p_Z(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_D'(z) &=
          \begin{cases}
            (d_1, d_2) \in D \colon d_2 - d_1 > 0 & \text{pro $z'$}, \\
            p_D(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'}(p) = p'$.

    \item
      Kanonický tah alokace záchranného vozidla $a'$ na výjezdovou stanici je funkce $M_{a'} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in Z,
        \\
        p_D'(z) &= p_D(z), \forall z \in Z,
        \\
        p_A'(a) &=
        \begin{cases}
          p_Z'(z) & \text{pro záchranné vozidlo $a' \in A \colon p_A(a') = v_{\emptyset}, v \in V$.}, \\
          p_A(a) & \text{pro $\forall a \in A \setminus \{ a' \}$},
        \end{cases}
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'a'}(p) = p'$.

    \item
      Kanonický tah prodloužení směny týmu $z'$ je funkce $M_{z'd} : p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in Z \\
        p_D'(z) &=
          \begin{cases}
            (d'_1, d'_2) \in D \colon d'_2 > d_2 \land d'_1 = d_1  & \text{pro $z'$, kde $(d_1, d_2) = p_{D}(z)$} \\
            p_D(z) & \text{pro $\forall z \in Z \setminus \{ z' \}$},
          \end{cases}
          \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{z'd}(p) = p'$.

    \item
      Kanonický tah identita je funkce $M_{id}: p \rightarrow p'$, kde
      \begin{align*}
        p_Z'(z) &= p_Z(z), \forall z \in z \\
        p_D'(z) &= p_D(z), \forall z \in Z \\
        p_A'(a) &= p_A(a), \forall a \in A,
      \end{align*}

      pro $p_Z, p_D, p_A \in p$ a $p_Z', p_D', p_A' \in p'$, kde $p, p' \in P_C$ a $M_{id}(p) = p'$.
  \end{enumerate}

\end{definice}

Vidíme, že popsat tah formálně je komplikované a pro naše účely zbytečné.
Proto dále budeme tahy definovat slovně, ale zároveň tak, aby nedocházelo k nejasnostem.

\begin{veta}[Vyjádření plánu kanonickými tahy]\label{veta:vztahMeziPlanyAKan}
  Každý plán $p \in P_C$ lze získat z prázdného plánu $p_0$ nějakou posloupností kanonických tahů.
  Prázdným plánem $p_0$ rozumíme plán, který nemá naalokován žádný tým ani vozidlo, čili $z \in Z, a \in A, p_Z, p_A \in p_0 \colon p_Z(z) = p_A(a) = v_{\emptyset}$.
\end{veta}
\begin{dukaz}
  Nechť libovolný plán $p \in P_C$.
  Vystačíme si pouze s tahy alokace týmu a alokace záchranného vozidla.
  Pro $\forall z_i \in Z$ zkonstruujeme tah $T_i$ tak, že bude tým alokovat podle $p_Z(z_i), p_Z \in p$.
  Stejně tak postupujme pro záchranná vozidla, zkonstruujme tah $U_i$ tak, že pro $\forall a_i \in A$ bude vozidlo alokovat podle $p_A(a_i), p_A \in p$.
  Nechť $T$ libovolná posloupnost tahů $T_i$ a $A_j$, $i \in \{ 1, \dots , Z_n\}, j \in \{ 1, \dots , A_n \}$.
  Pak $T(p_0) = p$.
\end{dukaz}

Vystačili jsme si pouze s tahy alokací týmu a vozidla.
Tah prodloužení směny jsme pro vyjádření libovolného plánu nepotřebovali.
To proto, že posloupnost tahů alokace týmu $z$ a následně prodloužení jeho směny je stejný tah, jako rovnou naalokování týmu $z$ s již prodlouženou směnou.
Závádění tahu prodloužení směny ale má svůj význam \ref{veta:konkrOptTahy}.

\begin{veta}[Inverzní kanonické tahy]\label{veta:invKanTahy}
  Nechť kanonické tahy alokování týmu $z$ tah $T_1$, alokování vozidla $a$ tah $T_2$ a prodloužení směny $z$ o $d$ tah $T_3$.
  Inverzní tahy k nim existují a jsou:

  \begin{enumerate}
    \item
      dealokování týmu $z$ tah $T_1^{-1}$,

    \item
      dealokování vozidla $a$ tah $T_2^{-1}$,

    \item
      zkrácení směny $z$ o $d$ tah $T_3^{-1}$,

    \item
      identita.
  \end{enumerate}
\end{veta}
\begin{dukaz}
  První ukažme, že kanonické tahy splňují nutné podmínky pro existenci inverzního tahu \ref{veta:inverzNutnost}.
  Pro identitu platí triviálně.

  Pro $T_1, T_2, T_3$ platí, že pokud se $T_i(p_1) = T_i(p_2)$, tak se muselo jednat o stejné plány už před provedením tahu a o různé, pokud $T_i(p_1) \neq T_i(p_2)$.
  Pro $T_1$ je dealokování týmu přesná konstrukce inverzního tahu z důkazu existence inverzní funkce \ref{veta:inverzNutnost}.
  Stejně tak pro $T_2$ a $T_3$.

  Inverzní tahy k $T_1, T_2$ a $T_3$ existují a jedná se právě o $T_1^{-1}, T_2^{-1}, T_3^{-1}$.
  Inverzní tah k identitě je identita.
\end{dukaz}

\begin{veta}\label{veta:kazdyInvSnizujeCenu}
  Každý inverzní kanonický tah kromě identity snižuje cenu.
\end{veta}
\begin{dukaz}
  Plyne přímo z konstrukce inverzních kanonických tahů \ref{veta:invKanTahy} a z definice ceny plánu \ref{df:cenaPlanu}.
\end{dukaz}

\begin{veta}
  Každé snížení ceny plánu lze docílit nějakou posloupností inverzních kanonických tahů.
\end{veta}
\begin{dukaz}
  Snížení ceny plánu z definice ceny plánu \ref{df:cenaPlanu} lze docílit jedině zkrácením směny nějakému týmu, dealokací nějakého týmu nebo dealokací nějakého vozidla.
  To jsou přesně inverzní kanonické tahy.
\end{dukaz}

\begin{veta}[Počet všech kanonických tahů]\label{veta:pocetKanTahu}
  Nechť $T$ množina všech kanonických tahů. Pak $|T| \leq (Z_n + A_n) \cdot V_n + Z_n + 1$.
\end{veta}
\begin{dukaz}
  Kanonické tahy jsou alokace týmu, prodloužení směny týmu, naalokování záchranného vozidla a identita.
  Každý tým, těch je celkově $Z_n$, můžeme naalokovat nejvýše na každou výjezdovou stanici, těch je $V_n$, pro libovolný plán $p \in P_C$.
  Pro naalokování vozidel platí také, akorát jich je $A_n$.
  Prodloužit směny můžeme nanejvýš všem již naalokovaným týmům, těch je nanejvýš $Z_n$.
  Tah identita je jen jeden.
\end{dukaz}

Tah je prostředek pro převádění mezi plány.
Tahy umíme provádět opakovaně a zároveň $\forall p \in P_C$ existuje posloupnost kannonických tahů $T = T_1 \circ \dots \circ T_n$ taková, že $T(p_0) = p$ \ref{veta:vztahMeziPlanyAKan},
jinými slovy, existují tahy takové, že každý $p \in P_C$ je z $p_0$ nějakou jejich posloupností \textit{dosažitelný}.

\begin{definice}[Dosažitelnost tahy]
  Nechť tahy $T_i$.
  Plán $p_2$ je dosažitelný tahy $T_i$ z plánu $p_1$, pokud existuje posloupnost tahů $T$ taková, že $T(p_1) = p_2$.
\end{definice}

Pomocí tahů můžeme $P_C$ \textit{prohledávat}.
Pokud optimální plán $p^* \in P_C$ je nějakými tahy $T_i$ dosažitelný z $p \in P_C$, pak ho můžeme prohledáváním, které začíná v $p$ nalézt.
Pomocí tahů můžeme $P_C$ prohledávat sofistikovaněji, než je jenom všechny procházet, jak jsme dělali v naivním řešení \ref{df:naivniRes}.
Některé plány totiž ani nemá smysl prohledávat, jako například plány, které naalokují záchranáře tak nešikovně, že neodbavují úspěšně žádný incident.
Taková naalokování jenom přispívají do ceny plánu, ale nijak do počtu úspěšně odbavených incidentů.
Dále budeme zkoumat, jaké plány má smysl prohledávat.

\begin{definice}[Plán optimální v ceně]
  Nechť množina incidentů $I$ a plán $p \in P_C \colon s_c(p, I) = r$.
  Řekneme, že $p$ je optimální v ceně právě tehdy, když
  pro plán $p'$ vzniklý z $p$ provedením libovolného inverzního kanonického tahu kromě identity platí: 
  \begin{equation*}
    s_c(p', I) < r.
  \end{equation*}
\end{definice}

\begin{definice}[$r$-optimální plán na množině incidentů]\label{veta:planOptVCene}
  Nechť plán $p \in P_C$ a $p^*$ optimální plán při účelové funkci $q^{\text{Lex}}$ \ref{df:lexPorovnaniPohotovost} na množině incidentů $I$.
  Řekneme, že plán $p$ je $r$-optimální na $I$ právě tehdy, když 
  \begin{equation*}
    s_c(p, I) = s_c(p^*, I) = r
  \end{equation*}
  a je optimální v ceně.
\end{definice}

\begin{veta}[Optimální plán při $q^{\text{Lex}}$ je $r$-optimální]\label{veta:optPlanOptVCene}
  Nechť libovolný optimální plán $p^* \in P_C$ při účelové funkci $q^{\text{Lex}}$ na množině incidentů $I$.
  Pak $p^*$ je $r$-optimální, pro $r = s_c(p^*, I)$.
\end{veta}
\begin{dukaz}
  Pro spor předpokládejme, že $p^*$ není $r$-optimální, takže není optimální v ceně.
  Existuje tak $T^{-1}$ inverzní kanonický tah různý od identity takový, že
  \begin{equation*}
    p'^* = T^{-1}(p^*) \colon s_c(p'^*, I) = s_c(p^*, I).
  \end{equation*}
  Každý inverzní kanonický tah kromě identity snižuje cenu plánu \ref{veta:kazdyInvSnizujeCenu}.
  Plán $p'^*$ by tak byl plán s nižší cenou než $p^*$, ale zároveň by odbavoval stejný počet incidentů.
  Vzhledem k návrhu $q^{\text{Lex}}$, by pak byl optimální $p'^*$ s jinou, nižší cenou než $p^*$, což je spor s optimalitou $p^*$.
\end{dukaz}

\begin{veta}[O optimálních tazích]\label{veta:optimalniTahy}
  Nechť množiny incidentů $I_0, \dots, I_n$ podle definice \ref{df:INC}.
  Nechť plán optimální v ceně $p_k \in P_C \colon s_c(p_k, I_k) = r$.
  Pak existuje plán optimální v ceně
  \begin{equation*}
    p_{k-1} \in P_C \colon s_c(p_{k-1}, I_{k-1}) = r \lor s_c(p_{k-1}, I_{k-1}) = r - 1
  \end{equation*}
  a tah $T = T_1 \circ T_2$ takový, že
  \begin{equation*}
    T(p_{k-1}) = p_k,
  \end{equation*}
  kde $T_1$ a $T_2$ jsou kanonické tahy, pro $\forall k \in \{ 1, \dots, n \}$.
  Takové tahy $T$ budeme nadále nazývat jako optimální tahy.
\end{veta}
\begin{dukaz}
  Nechť $i_1, \dots, i_k$ incidenty $I_k$ a $i'_1, \dots, i'_r$ incidenty, které odbaví $p_k$.
  Rozlišme dvě situace, které mohou nastat:
  \begin{enumerate}
    \item
      $i'_r \neq i_k$,

    \item
      $i'_r = i_k$.
  \end{enumerate}
  Ukažme, že v prvním případě je hledaný $p_{k-1}$ právě $p_k$ a tah $T$ identita.
  Platí $s_c(p_k, I_{k-1}) = r$, protože $p_k$ neodbaví poslední incident $i_k \not \in I_{k-1}$ a simulace incidenty prochází postupně \ref{simulaceAlgo},
  takže výpočet simulace na plánu $p_{k}$ a na množinách $I_k$ i $I_{k-1}$ je do $i_{k-1}$ incidentu totožný.
  Zároveň $p_k$ je optimální v ceně. Pro spor předpokládejme, že není, takže existuje inverzní kanonický tah $T^{-1}$ různý od identity takový,
  že
  \begin{equation*}
    s_c(T^{-1}(p_k), I_{k-1}) = s_c(p_k, I_{k-1}) \land u(T^{-1}(p_k)) < u(p_k).
  \end{equation*}
  To je ale spor s optimalitou v ceně $p_k$, protože $s_c(p_k, I_{k-1}) = s_c(p_k, I_k)$ a $T^{-1}(p_k)$ může odbavit nanejvýš $r$ incidentů na $I_k$ -- $T$ je buď dealokace nebo zkrácení směny,
  a tím se více incidentů neodbaví.
  Platilo by tak
  \begin{equation*}
    s_c(T^{-1}(p_k), I_{k}) = s_c(p_k, I_{k}) \land u(T^{-1}(p_k)) < u(p_k).
  \end{equation*}

  V druhém případě, je poslední incident $i_k = i'_r$ plánem $p_k$ odbaven.
  Z toho důvodu $p_k$ na množině inidentů $I_{k-1}$ odbavuje incidenty $i'_1, \dots, i'_{r-1}$, o jeden méně -- opět, simulace incidenty prochází postupně \ref{simulaceAlgo}.
  Platí tak, že $s_c(p_k, I_{k-1}) = r - 1$. Plán $p_k$ však nemusí být optimální v ceně. Uvažme tým záchranářů $z$, který odbavoval incident $i_k$.
  Pro tým $z$ pak pro spuštění simulace na plánu $p_k$ na množině incidentů $I_{k-1}$ platí:

  \begin{enumerate}
    \item
      Tým $z$ odbavuje jenom $i_k$, pak je v plánu $p_k$ naalokován zbytečně. O odbavení všech ostatních $r-1$ incidentů se postarájí ostatní týmy.

    \item
      Tým $z$ odbavuje i jiné incidenty $I_z$, ale jelikož
      \begin{equation*}
        \forall i_z \in I_z \colon T_I(i_z) < T_I(i_k),
      \end{equation*}
      tak $z$ odbavuje $i_k$ až po odbavení všech incidentů $I_z$.
      Aby $i_k$ úspěšně odbavil, může mít delší směnu, než by měl, pro odbavení $I_z$.
  \end{enumerate}

  V druhém případě se směna obecně nemusí vždy zkracovat.
  V obou případech ještě může být zbytečně naalokováno vozidlo, které $z$ používal pro odbavení $i_k$.

  Z pozorování plyne, že vždy existuje dvojice inverzních kanonických tahů $T_1^{-1}$ a $T_1^{-1}$, kde pro jejich složení $T^{-1} = T_1^{-1} \circ T_1^{-1}$,
  platí, že $T^{-1}(p_k)$ je optimální v ceně a $s_c(T^{-1}(p_k), I_{k-1}) = r - 1$.
  Těmi jsou buď:
  \begin{enumerate}
  \item
    dealokace týmu a dealokace vozidla, 
  \item
    zkrácení týmu a dealokace vozidla,
  \item
    dealokace týmu a identita,
  \item
    zkrácení týmu a identita,
  \item
    identita a identita.
  \end{enumerate}

  Ukázali jsme existenci $T^{-1}$ v obou případech. Z definice inverzního kanonického tahu:
  \begin{equation*}
    T = T_1 \circ T_2 \colon p_k = T(p_{k-1}), 
  \end{equation*}
  pro $T_1$ a $T_2$ inverzní tahy k $T_1^{-1}$ a $T_1^{-1}$.
\end{dukaz}

\begin{veta}[O dosažitelnosti optimálního plánu optimálními tahy]
  Optimální plán $p^* \in P_C$ na množině incidentů $I$ při účelové funkci $p^{\text{Lex}}$ je z $p_0$ dosažitelný nějakou posloupností optimálních tahů $T_1 \circ \dots T_{|I|-1}$.
\end{veta}
\begin{dukaz}
  Nechť $n = |I|$.
  Plán $p^*$ je optimální a odbavuje $r = s_c(p^*, I)$ incidentů.
  Existuje pro něj podle věty \ref{veta:optimalniTahy} tah $T_{n-1}$ a plán $p_{n-1}$ takové, že
  \begin{equation*}
    p^* = T(p_{n-1})
  \end{equation*}
  a $p_{n-1}$ odbavuje stejně nebo o jeden méně incidentů na $I_{n-1}$, než $r$.
  Opět z věty \ref{veta:optPlanOptVCene} pro něj existuje $p_{n-2}, T_{n-2} \colon p_{n-1} = T_{n-2}(p_{n-2})$.

  Takovou konstrukcí sestrojíme $p_{k}, T_{k}, \forall k \in \{ 0, \dots, n-1 \}$. 
  Plán $p_0$ je přitom prázdný plán a tahy $T_k$ jsou optimální tahy, takže se jedná o hledanou posloupnost takovou, že
  \begin{equation*}
    p^* = (T_0 \circ T_1 \circ \dots \circ T_{n-1})(p_0).
  \end{equation*}
\end{dukaz}

\begin{algorithm}[h]
  \begin{algorithmic}[1]
  \Function{OptimalMovesSearch}{$p$, $I_k$, $h$}
    \If{$k = h$}
      \State \Return $\{ p \}$
    \EndIf
    \State $T^*_k$ \gets $k$-optimální tahy podle \ref{veta:konkrOptTahy}
    \State $P^*$ \gets $\emptyset$
    \For{$T^* \in T^*_k$}
      \State $p'$ \gets $T^*(p)$
      \State $P'^*$ \gets \text{OptimalMovesSearch($p'$, $I_{k+1}$, $h$)}
      \If{$u(p) = u(p'), p' \in P'^*$}
        \State $P^*$ sjednoť s $P'^*$
      \ElsIf{$u(p') < u(p), p' \in P'^*$}
        \State $P^*$ nahraď $P'^*$
      \EndIf
    \EndFor
    \State \Return $P^*$
  \EndFunction
  \end{algorithmic}
  \caption{Algoritmus rekurzivního prohledávání prostoru plánů $k$-optimálními}
  \label{alg:rekProhPlanu}
\end{algorithm}

Pro zjištění všech optimálních plánu $P^*$ na množině incidentů $I$ algoritmus \ref{alg:rekProhPlanu} zavoláme: $P^* = $ OptimalMovesSearch($p_0$, $I_1$, $|I|$).

\begin{veta}\label{veta:algoritmusPredpoklady}
  Za předpokladu, že optimální plán $p^*$ odbaví všechny incidenty $I$ a použijeme účelovou funkci $q^{\text{Lex}}$ \ref{df:lexPorovnaniPohotovost},
  je algoritmus rekurzivního prohledávání prostoru plánů $k$-optimálními tahy \ref{alg:rekProhPlanu} korektní a úplný.
\end{veta}
\begin{dukaz}
  V kroku 5 konstruujeme $T^*_k$ podle \ref{veta:konkrOptTahy}, o nich víme že se jedná o $k$-optimální tahy.
  Algoritmus tudiž rekurzivně prohledává každou posloupnost $k$-optimálních tahů $T^*_1, \dots, T^*_{|I|}$.
  Z toho důvodu a z dosažitelnosti \ref{veta:optJeDosaz} prohledá i cestu tvořící libovolný optimální plán $p^* = (T^*_1 \circ \dots \circ T^*_{|I|})(p_0)$ odbavující všechny incidenty $I$.
  Algoritmus je úplný.

  Ze všech zkonstruovaných plánů v krocích 10 až 14 vybíráme ty s nejnižší cenou.
  Z úplnosti žádný nevynecháme, takže nalezne plány optimální v ceně $P_{|I|}$ na $I$.
  Pro
  \begin{alignat*}
    \forall p^* \in P_{|I|} \colon q^{\text{Lex}}(p^*) \geq q^{\text{Lex}}(p), \quad && p \in P_C
  \end{alignat*}
  z definice $q^{\text{Lex}}$. Algoritmus je korektní.
\end{dukaz}

\begin{definice}[Strom optimálních tahů]
  Strom optimálních tahů rozumíme strom rekurze algoritmu prohledávání prostoru plánů $k$-optimálními tahy \ref{alg:rekProhPlanu}.
\end{definice}

\begin{veta}\label{veta:cestaAoptimum}
  Spusťme algoritmus \ref{alg:rekProhPlanu} na množině plánů, kde optimální plány při $q^{\text{Lex}}$ odbavují všechny incidenty.
  Libovolná cesta z kořene do listu stromu optimálních tahů v hloubce $|I|$ , odpovídá nějakému optimálnímu řešení.
  Z úplnosti algoritmu \ref{veta:algoritmusPredpoklady} i každé optimální řešení odpovídá nějaké takové cestě.
\end{veta}
\begin{dukaz}
\end{dukaz}

Předpoklad, že za účelovou funkci použijeme $q^{\text{Lex}}$ není problém, protože patří mezi preferované účelové funkce, více probráno v sekci \ref{kap:opt1Uc}.
Avšak předpoklad, že optimální plán umí odbavit všechny incidenty je dost silný.
Jednoduše takovou podmínku nelze ověřit a rádi bychom uměli najít optimální plány i takové, které neumí odbavit všechny incidenty.
Ukažme si, jak se prohledávání plánů $k$-optimálními tahy \ref{alg:rekProhPlanu} bude chovat, pokud je optimální plán nebude umět všechny odbavit.

Nechť množina incidentů $I$ taková, že optimální plán $p^*$ splňuje $s_c(p^*, I) \neq |I|$ při účelové funkci $q^{\text{Lex}}$.
Z toho plyne, že neexistuje žádný plán, který by uměl odbavit všechny incidenty.
Spusťme algoritmus \ref{alg:rekProhPlanu} pro množinu $I$.
Analyzujme chod algoritmu \ref{alg:rekProhPlanu}, jak prochází \textit{stromem optimálních tahů}.

Z věty \ref{veta:cestaAoptimum} víme, že pokud optimální plány při $q^{\text{Lex}}$ odbavují všechny incidenty, libovolná 
cesta z kořene do listu v hloubce velikosti množiny incidentů odpovídá nějakému optimálnímu řešení.
Pro list v menší hloubce $k$ cesta odpovídá plánu, pro který je množina $k$-optimálních tahů prázdná.
Neproběhne cyklus na řádcích 7 až 15 \ref{alg:rekProhPlanu}, a rekurze se tím předčasně ukončí.
Pokud algoritmus \ref{alg:rekProhPlanu} spustíme na $I$, tak nebude existovat žádná cesta z kořene do listu v hloubce $|I|$, protože se rekurze předčasně ukončí pro každý plán,
protože neexistuje žádný, který by uměl odbavit všechny.

Algoritmus tudiž vrátí plány, které odbaví prvních nejvíce $k$ incidentů.
Mezi tyto plány ale $p^*$ obecně nepatří, například co když $p^*$ prvních $k$ plánu neodbavuje a odbavuje všechny $|I| - k > k$ plánů. 
Takové plány algoritmus vůbec \ref{alg:rekProhPlanu} neprohledal.

Upravme algoritmus \ref{alg:rekProhPlanu}, že $T^*_k$ nebude nikdy prázdná množina a bude vždy obsahovat alespoň tah identita. 
Rekurze se nikdy neukončí předčasně, a pokud pro žádné $P_{k+1}$ nepůjde odbavit všechny incidenty $I_{k+1}$, tak incident $i_{k+1}$ \uv{přeskočíme} a budeme pokračovat ve výpočtu.

\begin{definice}[Upravené prohledávání stromu optimálních tahů]\label{df:upravenyAlg}
  V algoritmu \ref{df:rekProhPlanu} v kroku 5 bude množina $T^*_k$ obsahovat vždy alespoň kanonický tah identita.
\end{definice}

\begin{definice}
  Nechť $I$ množina incidentů a $p \in P_C$.
  Řekneme, že plán $p$ je $k$-optimální v ceně na $I$ právě tehdy, když úspěšně odbaví $k$ incidentů, $s_c(p, I_k) = k$ a zároveň
  pro plán $p'$ vzniklý z $p$ provedením libovolného inverzního kanonického tahu kromě tahu identita platí: $s_c(p', I) < |I|$.
\end{definice}

\begin{veta}
  Nechť množiny incidentů $I_1, \dots, I_n$ podle definice \ref{df:INC}.
  Nechť množiny $P_{k}$ všechny $l$-optimální plány v ceně na incidentech $I_k$, $\forall k \in \{ 1, \dots, n \}, l \leq k$.
  Nechť $p_k \in P_k$ libovolný $k$-optimální plán v ceně na $I_k$.

  Pak existuje $p_{k-1}$ $(k-1)$-optimální plán v ceně na $I_{k-1}$ takový, že $T(p_{k-1}) = p_k$ pro nějaký $(k-1)$-optimální tah $T$. 
\end{veta}
\begin{dukaz}
  Tah $T$ zkonstruujeme identickým způsobem jako v důkazu věty \ref{veta:vztahOptim}. Vždy existuje, nejhůře $T$ bude identita z věty \ref{veta:OmeneIncidentech}.
\end{dukaz}

\begin{veta}[Dosažitelnost $k$-optimálního plánu v ceně z prázdného plánu]\label{veta:dosOptZPrazdnehoPlanu}
  Nechť množiny incidentů $I_1, \dots, I_n$ podle definice \ref{df:INC}.
  Nechť množiny $P_{k}$ všechny $l$-optimální plány v ceně na incidentech $I_k$, $\forall k \in \{ 1, \dots, n \}, l \leq k$.
  Nechť $p_k \in P_k$ libovolný $k$-optimální plán v ceně na $I_k$.

  Pak $p_k$ je dosažitelný z $p_0$ nějakou posloupností tahů $T_1 \in T^*_1, T_2 \in T^*_2, \dots, T_k \in T^*_k$, kde $T^*_l$ jsou $l$-optimální tahy, $\forall l \in \{ 1, \dots, k-1 \}$.
\end{veta}
\begin{dukaz}
  Důkaz totožný větě \ref{veta:dosOptZPrazdnehoPlanu}.
\end{dukaz}

\begin{veta}
  Upravený algoritmus \ref{alg:rekProhPlanu} podle \ref{df:upravenyAlg} nalezne všechny $k$-optimální plány v ceně, kde $k = s_c(p^*, I)$,
  pro optimální plán $p^*$ při účelové funkci $q^{\text{Lex}}$.
\end{veta}
\begin{dukaz}
  Totožné jako výše.
\end{dukaz}

